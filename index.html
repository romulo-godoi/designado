<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-translate="pageTitle">Minhas Designações</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- CSS Completo --- */
        :root {
            --bg-color: #0d0d10; --surface-color: #1c1c21; --surface-lighter-color: #25252b;
            --border-color: #333338; --completed-item-bg: #101012; --body-outer-bg: #030304;
            --text-primary-color: #eaeaf0; --text-secondary-color: #90909c;
            --accent-primary-color: #8a9ff9; --accent-secondary-color: #5c6db5; --accent-alt-color: #f2c079;

            --error-color: #e680a7; --success-color: #74c7a3;
            --list-color-1: #2f588f; --list-color-2: #457c7c; --list-color-3: #7d5c9e;
            --list-color-4: #82a05e; --list-color-5: #bc906d;
            --border-radius-outer: 12px; --border-radius-inner: 10px; --font-family: 'Inter', sans-serif;
            --transition-speed-fast: 0.2s; --transition-speed-med: 0.3s; --transition-speed-slow: 0.5s;
            --header-bg-gradient: linear-gradient(180deg, var(--surface-color), var(--bg-color));
            --button-disabled-opacity: 0.5; --scrollbar-thumb: var(--accent-secondary-color); --scrollbar-track: transparent;
            --modal-overlay-bg: rgba(10, 10, 15, 0.8); --tooltip-bg: var(--surface-lighter-color);
            --input-bg: var(--bg-color); --input-focus-bg: var(--surface-color); --input-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            --input-focus-shadow: 0 0 0 3px rgba(122,145,232,0.2), inset 0 1px 3px rgba(0,0,0,0.1);
            --date-picker-indicator-filter: invert(0.7);
        }

        body.light-theme {
            --bg-color: #f4f4f8; --surface-color: #ffffff; --surface-lighter-color: #f0f0f2;
            --border-color: #dcdce1; --completed-item-bg: #e8e8ed; --body-outer-bg: #fdfdff;
            --text-primary-color: #1d1d1f; --text-secondary-color: #5f5f64;
            --accent-primary-color: #006ee6; --accent-secondary-color: #504fbd; --accent-alt-color: #e68a00;

            --list-color-1: #cee0ff; --list-color-2: #c7eae7; --list-color-3: #e9d6ff;
            --list-color-4: #e1f0d2; --list-color-5: #fae9d8;

            --header-bg-gradient: linear-gradient(180deg, var(--surface-color), var(--bg-color));
            --button-disabled-opacity: 0.6; --scrollbar-thumb: var(--accent-secondary-color); --scrollbar-track: #eee;
            --modal-overlay-bg: rgba(50, 50, 60, 0.7); --tooltip-bg: var(--surface-color);
            --input-bg: #efeff2; --input-focus-bg: #ffffff; --input-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            --input-focus-shadow: 0 0 0 3px rgba(0, 110, 230, 0.2), inset 0 1px 2px rgba(0,0,0,0.05);
            --date-picker-indicator-filter: invert(0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; } html { scroll-behavior: smooth; height: 100%; }
        body { font-family:var(--font-family); background-color: var(--body-outer-bg); color:var(--text-primary-color); min-height:100vh; -webkit-tap-highlight-color:transparent; position: relative; overflow-x: hidden; transition: background-color var(--transition-speed-med), color var(--transition-speed-med); }
        .mobile-view-container { background-color:var(--bg-color); width: 100%; height: 100vh; display:flex; flex-direction:column; overflow:hidden; z-index: 1; position: relative; transition: background-color var(--transition-speed-med); }
        header.main-header { background: var(--header-bg-gradient); padding:18px 20px; border-bottom:1px solid var(--border-color); flex-shrink:0; text-align:center; z-index: 10; position: relative; display: flex; justify-content: center; align-items: center; transition: background var(--transition-speed-med), border-color var(--transition-speed-med); }
        header.main-header h1 { color:var(--accent-primary-color); font-size: 1.4em; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: color var(--transition-speed-med); }
        #themeToggleBtn { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background:none; border: none; color: var(--text-secondary-color); font-size: 1.3em; cursor: pointer; padding: 5px; line-height: 1; opacity: 0.8; transition: color var(--transition-speed-fast), opacity var(--transition-speed-fast); z-index: 11;} #themeToggleBtn:hover { opacity: 1; }

        .content-scroll { flex-grow:1; overflow-y:auto; scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); } .content-scroll::-webkit-scrollbar { width: 8px; } .content-scroll::-webkit-scrollbar-track { background: var(--scrollbar-track); } .content-scroll::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; border: 2px solid var(--bg-color); }
        .dashboard-section, .collapsible-section { border-bottom: 1px solid var(--border-color); transition: background-color var(--transition-speed-med), border-color var(--transition-speed-med); } .dashboard-section { padding: 20px; background-color: var(--surface-color); position: relative; /* Tooltip positioning context */ }
        .section-header h2, .dashboard-section > h3 { font-size: 0.8em; font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary-color); margin: 15px 0 8px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); transition: color var(--transition-speed-med), border-color var(--transition-speed-med);} .section-header h2 { color: var(--accent-primary-color); margin: 0; padding: 0; border-bottom: none; flex-grow: 1; font-weight: 600; letter-spacing: 1px; transition: color var(--transition-speed-med); }
        #weeklyCalendarContainer > h3 { text-align: center; color: var(--accent-alt-color); border-bottom: none; margin-bottom: 8px; font-weight: 600; letter-spacing: 1px; transition: color var(--transition-speed-med);}
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .calendar-nav button { background: none; border: 1px solid var(--border-color); color: var(--text-secondary-color); padding: 4px 10px; border-radius: var(--border-radius-inner); font-size: 0.8em; cursor: pointer; transition: all var(--transition-speed-fast); } .calendar-nav button:hover:not(:disabled) { background-color: var(--accent-primary-color); color: #fff; border-color: var(--accent-primary-color); transform: translateY(-1px); } .calendar-nav button:active:not(:disabled) { transform: scale(0.97); } .calendar-nav button:disabled { opacity: var(--button-disabled-opacity); cursor: not-allowed; background-color: transparent !important; border-color: var(--border-color); transform: none !important; } #calendarWeekLabel { font-size: 1em; font-weight: 600; color: var(--accent-alt-color); flex-grow: 1; text-align: center; transition: color var(--transition-speed-med);}
        #upcomingListContainer > h3 { color: var(--text-secondary-color); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; } .day-header{font-size:0.7em;text-align:center;color:var(--text-secondary-color);padding-bottom:5px;font-weight:500;text-transform:uppercase;border-bottom:1px solid var(--border-color);margin-bottom:5px; transition: color var(--transition-speed-med), border-color var(--transition-speed-med);} .day-cell{font-size:0.8em;text-align:center;background-color:var(--bg-color);border-radius:var(--border-radius-inner);padding:8px 4px;min-height:65px;display:flex;flex-direction:column;align-items:center;border:1px solid transparent; transition: background-color var(--transition-speed-fast), transform var(--transition-speed-fast), border-color var(--transition-speed-fast); position: relative; /* Tooltip */ } .day-cell:hover { background-color: var(--surface-lighter-color); transform: scale(1.03);} .day-cell.today{border-color:var(--accent-alt-color);background-color:var(--surface-lighter-color); box-shadow: 0 0 8px color-mix(in srgb, var(--accent-alt-color) 30%, transparent); transition: background-color var(--transition-speed-med), border-color var(--transition-speed-med), box-shadow var(--transition-speed-med); } .day-number{font-weight:600;margin-bottom:4px;color:var(--text-primary-color);transition: color var(--transition-speed-med);} .day-cell.today .day-number{color:var(--accent-alt-color);} .day-assignments{list-style:none;padding:0;width:100%;}
        .assignment-marker{display:block;font-size:0.7em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background-color:var(--accent-secondary-color);color:var(--text-primary-color);padding:3px 5px;margin-top:4px;border-radius:4px;text-align:center; /* Center text now */ box-shadow: 0 1px 2px rgba(0,0,0,0.15); cursor: pointer; transition: background-color var(--transition-speed-med), color var(--transition-speed-med); font-weight: 500; /* Make it slightly bolder */ }
        body.light-theme .assignment-marker { color: var(--bg-color); /* Darker text on marker for light theme */ }
        #upcomingList{list-style:none;padding:0;} .upcoming-item{display:flex;justify-content:space-between;align-items:center;font-size:0.9em;padding:10px 5px;border-bottom:1px dashed var(--border-color); transition: background-color var(--transition-speed-fast), border-color var(--transition-speed-med); } .upcoming-item:last-child{border-bottom:none;} .upcoming-item:hover { background-color: color-mix(in srgb, var(--text-primary-color) 3%, transparent); } .upcoming-item .date{color:var(--text-secondary-color);font-size:0.9em;white-space:nowrap;margin-left:10px; transition: color var(--transition-speed-med);} .upcoming-item .type{font-weight:500; transition: color var(--transition-speed-med);}
        .collapsible-section{background-color:var(--surface-color); transition: background-color var(--transition-speed-med), border-color var(--transition-speed-med); } .section-header{padding:18px 20px;cursor:pointer;transition: background-color var(--transition-speed-fast), box-shadow var(--transition-speed-fast);position:relative;z-index:1; display: flex; align-items: center;} .section-header:hover{background-color:var(--surface-lighter-color); box-shadow: inset 0 0 10px rgba(0,0,0,0.1); } .section-header i{font-size:0.9em;transition:transform var(--transition-speed-med) ease-out;color:var(--accent-primary-color);flex-shrink:0; margin-left: 10px;} .collapsible-section.is-open .section-header i{transform:rotate(90deg);} .section-content{max-height:0;overflow:hidden;transition: max-height var(--transition-speed-med) ease-out, padding var(--transition-speed-med) ease-out, border-top var(--transition-speed-med);padding:0 20px;background-color:var(--surface-lighter-color); border-top: 1px solid transparent; transition: background-color var(--transition-speed-med), border-color var(--transition-speed-med); } .collapsible-section.is-open .section-content{max-height:2000px;padding:25px;transition:max-height var(--transition-speed-slow) ease-in-out, padding var(--transition-speed-slow) ease-in-out, border-top var(--transition-speed-slow); border-top: 1px solid var(--border-color); } #listSection.is-open .section-content{background-color:var(--bg-color);padding:0;}
        #assignmentForm{display:flex;flex-direction:column;gap:18px;} .form-group{display:flex;flex-direction:column;} .form-group#customTypeGroup{display:none;margin-top:-5px;padding-left:15px;border-left:3px solid var(--accent-primary-color);padding-top:10px; margin-left: 5px;} .form-group#customTypeGroup label{font-size:0.8em;} label{margin-bottom:6px;font-weight:500;font-size:0.85em;color:var(--text-secondary-color);letter-spacing: 0.5px; transition: color var(--transition-speed-med);} select,input[type="date"],input[type="text"]{padding:14px 16px;background-color:var(--input-bg);border:1px solid var(--border-color);border-radius:var(--border-radius-inner);color:var(--text-primary-color);font-family:inherit;font-size:1rem;width:100%;transition: all var(--transition-speed-fast); box-shadow: var(--input-shadow); } select:hover, input:hover { border-color: var(--text-secondary-color); } select:focus,input:focus{outline:none;border-color:var(--accent-primary-color);background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow);} select option,select optgroup{background-color:var(--bg-color);color:var(--text-primary-color);font-weight:normal;} select optgroup{padding:6px 0; font-weight: 600;} select optgroup.frequent-group{font-style:normal;font-weight:bold;color:var(--accent-primary-color);} input[type="date"]{color: var(--text-secondary-color); } input[type="date"]:focus, input[type="date"]:valid { color: var(--text-primary-color); } input[type="date"]::-webkit-calendar-picker-indicator{filter:var(--date-picker-indicator-filter);cursor:pointer;opacity:0.7;transition:opacity var(--transition-speed-fast), filter var(--transition-speed-fast);} input[type="date"]::-webkit-calendar-picker-indicator:hover{opacity:1;} button[type="submit"]{padding:15px 20px;background:linear-gradient(45deg, var(--accent-primary-color), var(--accent-secondary-color));color:#fff;border:none;border-radius:var(--border-radius-inner);cursor:pointer;font-size:1.05rem;font-weight:600;text-align:center;width:100%;margin-top:8px;transition: all var(--transition-speed-fast); box-shadow: 0 3px 8px rgba(0,0,0,0.2);} button[type="submit"]:hover{opacity:0.9; box-shadow: 0 5px 12px color-mix(in srgb, var(--accent-primary-color) 30%, transparent); } button[type="submit"]:active{transform:scale(0.97); box-shadow: 0 1px 3px rgba(0,0,0,0.2);}
        body.light-theme select optgroup.frequent-group { color: var(--accent-secondary-color); }

        .assignment-list { list-style: none; padding: 0; }
        .assignment-item { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 18px 15px; color: var(--text-primary-color); border-bottom: 1px solid var(--border-color); cursor: pointer; transition: all var(--transition-speed-fast); position: relative; background-color: var(--surface-color); }
        .assignment-item:last-child { border-bottom: none; }
        .assignment-item:not([data-iscelebration="true"]):hover { filter: brightness(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        body.light-theme .assignment-item:not([data-iscelebration="true"]):hover { filter: brightness(0.98); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .assignment-item[data-iscelebration="true"] { cursor: default; background-color: color-mix(in srgb, var(--accent-primary-color) 20%, var(--bg-color)); }
        body.light-theme .assignment-item[data-iscelebration="true"] { background-color: color-mix(in srgb, var(--list-color-3) 70%, var(--bg-color)); }
        .assignment-item:nth-child(5n+1):not([data-iscelebration="true"]){background-color:var(--list-color-1);} .assignment-item:nth-child(5n+2):not([data-iscelebration="true"]){background-color:var(--list-color-2);} .assignment-item:nth-child(5n+3):not([data-iscelebration="true"]){background-color:var(--list-color-3);} .assignment-item:nth-child(5n+4):not([data-iscelebration="true"]){background-color:var(--list-color-4);} .assignment-item:nth-child(5n):not([data-iscelebration="true"]){background-color:var(--list-color-5);}
        .assignment-item.is-completed { background-color: var(--completed-item-bg) !important; opacity: 0.65; filter: grayscale(50%); cursor: default; transition: background-color var(--transition-speed-med), opacity var(--transition-speed-med), filter var(--transition-speed-med); }
        body.light-theme .assignment-item.is-completed { filter: grayscale(30%); opacity: 0.7; }
        .assignment-item.is-completed:hover{ transform: translateY(0); filter: grayscale(50%) brightness(1); box-shadow: none; opacity: 0.7;}
        body.light-theme .assignment-item.is-completed:hover { filter: grayscale(30%) brightness(1); opacity: 0.75; }
        .assignment-emoji { font-size: 1.9em; margin-bottom: 8px; line-height: 1; display: block; transition: transform var(--transition-speed-fast); }
        .assignment-item:not([data-iscelebration="true"]):hover .assignment-emoji { transform: scale(1.1); }
        .assignment-type { font-size: 1em; font-weight: 600; margin-bottom: 6px; color: var(--text-primary-color); line-height: 1.3; display: block; transition: color var(--transition-speed-med); }
        .assignment-date { font-size: 0.85em; font-weight: 500; color: var(--text-secondary-color); display: block; margin-bottom: 4px; transition: color var(--transition-speed-med);}
        .assignment-item.is-completed .assignment-emoji { filter: grayscale(80%); opacity: 0.7; transform: scale(1);}
        .assignment-item.is-completed .assignment-type { text-decoration: line-through; text-decoration-thickness: 1px; color: var(--text-secondary-color); }
        .assignment-notes { font-size: 0.75em; color: var(--text-secondary-color); margin-top: 4px; font-style: italic; word-break: break-word; max-width: 90%; }
        body.light-theme .assignment-item:not(.is-completed):not([data-iscelebration="true"]) .assignment-type { color: #1a1a1e; font-weight: 600; }
        body.light-theme .assignment-item:not(.is-completed):not([data-iscelebration="true"]) .assignment-date,
        body.light-theme .assignment-item:not(.is-completed):not([data-iscelebration="true"]) .assignment-notes { color: #3d3d41; }

        .modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color: var(--modal-overlay-bg); backdrop-filter:blur(3px);justify-content:center;align-items:center;opacity:0;transition:opacity var(--transition-speed-med) ease-out;} .modal-overlay.is-visible{display:flex;opacity:1;} .modal-content{background-color:var(--surface-color);padding:30px;border-radius:var(--border-radius-inner);box-shadow:0 8px 25px rgba(0,0,0,0.3);width:90%;max-width:400px;position:relative;display:flex;flex-direction:column;gap:18px;border:1px solid var(--border-color);transform:scale(0.95);transition: transform var(--transition-speed-med) ease-out 0.1s, background-color var(--transition-speed-med), border-color var(--transition-speed-med);} .modal-overlay.is-visible .modal-content{transform:scale(1);} .modal-content h4{color:var(--accent-primary-color);margin-bottom:8px;text-align:center;font-size:1.2em;font-weight:600;word-break:break-word; transition: color var(--transition-speed-med);} .modal-content .action-buttons,.modal-content .edit-view{display:flex;flex-direction:column;gap:12px;} .modal-content button{padding:12px 18px;border:none;border-radius:var(--border-radius-inner);cursor:pointer;font-weight:600;font-size:0.95em;transition:all var(--transition-speed-fast);width:100%;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 5px rgba(0,0,0,0.15);} .modal-content button:hover:not(:disabled){opacity:0.9;box-shadow:0 4px 10px rgba(0,0,0,0.2);transform:translateY(-1px);} .modal-content button:active:not(:disabled){transform:scale(0.97);box-shadow:0 1px 2px rgba(0,0,0,0.1);} .modal-content button:disabled { opacity: var(--button-disabled-opacity); cursor: not-allowed; transform: none !important; filter: grayscale(30%); }
        #modalBtnComplete{background-color:var(--success-color);color:#fff;} #modalBtnComplete:disabled { background-color: var(--text-secondary-color); color: var(--surface-lighter-color); cursor: not-allowed; } #modalBtnEdit{background-color:var(--accent-alt-color);color:#fff;} #modalBtnDelete{background-color:var(--error-color);color:#fff;} #modalBtnCancel,#modalBtnCancelEdit{background-color:var(--surface-lighter-color);color:var(--text-primary-color);border:1px solid var(--border-color);}
        body.light-theme #modalBtnComplete, body.light-theme #modalBtnEdit, body.light-theme #modalBtnDelete { color: var(--bg-color); /* Dark text on colored buttons */ }
        body.light-theme #modalBtnComplete:disabled { background-color: #cccccc; color: #777777; }
        .edit-view{display:none;} .edit-view .form-group{width:100%;} .edit-view label{font-size:0.8em;} #modalBtnSaveEdit{background-color:var(--success-color);color:#fff;}
        body.light-theme #modalBtnSaveEdit { color: var(--bg-color); }

        .no-assignments, .no-upcoming{font-size:0.9em;text-align:center;color:var(--text-secondary-color);padding:30px 20px;font-style:italic;background:transparent; transition: color var(--transition-speed-med);} .no-assignments{padding:40px 20px;}
        #confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:2000;} .confetti-piece{position:absolute;width:10px;height:15px;opacity:0.9;animation:fallFadeOut 3.5s ease-in forwards;border-radius:3px;background-image:linear-gradient(45deg,var(--accent-primary-color),var(--success-color),var(--accent-alt-color));} @keyframes fallFadeOut{0%{transform:translateY(-30px) rotate(0deg) scale(1);opacity:1;}100%{transform:translateY(110vh) rotate(1080deg) scale(0.5);opacity:0;}}

        /* Tooltip */
        .calendar-tooltip { position: absolute; display: none; background-color: var(--tooltip-bg); color: var(--text-primary-color); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: var(--border-radius-inner); font-size: 0.8em; z-index: 1010; pointer-events: none; white-space: normal; max-width: 150px; box-shadow: 0 3px 8px rgba(0,0,0,0.2); opacity: 0; transform: translateY(5px); transition: opacity 0.15s ease-out, transform 0.15s ease-out, background-color var(--transition-speed-med), color var(--transition-speed-med), border-color var(--transition-speed-med); }
        .calendar-tooltip.is-visible { display: block; opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
     <div class="mobile-view-container">
         <header class="main-header">
             <h1 data-translate="pageTitle">Minhas Designações</h1>
             <button id="themeToggleBtn" data-translate-title="themeToggleButton"><i class="fas fa-sun"></i></button>
         </header>
         <div class="content-scroll">
             <div class="dashboard-section">
                 <div id="weeklyCalendarContainer">
                     <div class="calendar-nav">
                         <button id="prevWeekBtn" data-translate="prevWeekButton">< Ant</button> <!-- Removed disabled -->
                         <span id="calendarWeekLabel"></span>
                         <button id="nextWeekBtn" data-translate="nextWeekButton">Próx ></button>
                     </div>
                     <div id="weeklyCalendar" class="calendar-grid"></div>
                 </div>
                 <div id="upcomingListContainer">
                     <h3 data-translate="upcomingTitle">Próximos 7 dias</h3>
                     <ul id="upcomingList">
                         <li class="no-upcoming" data-translate="loading">...</li>
                     </ul>
                 </div>
             </div>
             <div class="collapsible-section" id="formSection">
                 <div class="section-header" onclick="toggleSection('formSection')">
                     <h2 data-translate="addAssignmentHeader">Adicionar Nova</h2><i class="fas fa-chevron-right"></i>
                 </div>
                 <div class="section-content">
                     <form id="assignmentForm">
                         <div class="form-group">
                             <label for="assignmentType" data-translate="formTypeLabel">Tipo</label>
                             <select id="assignmentType" name="assignmentType" required>
                                 <option value="" disabled selected data-translate="formTypeSelectOption">...</option>
                             </select>
                         </div>
                         <div class="form-group" id="customTypeGroup">
                             <label for="customAssignmentType" data-translate="formCustomTypeLabel">Nome</label>
                             <input type="text" id="customAssignmentType" name="customAssignmentType" data-translate-placeholder="formCustomTypePlaceholder" placeholder="...">
                         </div>
                         <div class="form-group">
                             <label for="assignmentDate" data-translate="formDateLabel">Data</label>
                             <input type="date" id="assignmentDate" name="assignmentDate" required>
                         </div>
                         <div class="form-group">
                             <label for="assignmentNotes" data-translate="formNotesLabel">Obs</label>
                             <input type="text" id="assignmentNotes" name="assignmentNotes" data-translate-placeholder="formNotesPlaceholder" placeholder="...">
                         </div>
                         <button type="submit" data-translate="formAddButton">Adicionar</button>
                     </form>
                 </div>
             </div>
             <div class="collapsible-section is-open" id="listSection">
                 <div class="section-header" onclick="toggleSection('listSection')">
                     <h2 data-translate="allAssignmentsHeader">Todas Designações</h2><i class="fas fa-chevron-right"></i>
                 </div>
                 <div class="section-content">
                     <ul id="assignmentsList" class="assignment-list">
                         <li class="no-assignments" data-translate="loading">...</li>
                     </ul>
                 </div>
             </div>
         </div>
     </div>
     <div id="actionModal" class="modal-overlay">
         <div class="modal-content">
            <h4 id="modalTitle" data-translate="loading">...</h4>
            <input type="hidden" id="modalAssignmentId">
            <div class="action-buttons">
                <button id="modalBtnComplete"></button>
                <button id="modalBtnEdit" data-translate="modalEditButton">Editar</button>
                <button id="modalBtnDelete" data-translate="modalDeleteButton">Excluir</button>
                <button id="modalBtnCancel" data-translate="modalCancelButton">Cancelar</button>
            </div>
            <div class="edit-view">
                <div class="form-group">
                    <label for="modalEditDate" data-translate="formDateLabel">Data</label>
                    <input type="date" id="modalEditDate">
                </div>
                <div class="form-group">
                    <label for="modalEditNotes" data-translate="formNotesLabel">Obs</label>
                    <input type="text" id="modalEditNotes" data-translate-placeholder="formNotesPlaceholder" placeholder="...">
                </div>
                <button id="modalBtnSaveEdit" data-translate="modalSaveButton">Salvar</button>
                <button id="modalBtnCancelEdit" data-translate="modalCancelButton">Cancelar</button>
            </div>
         </div>
     </div>
     <div id="confetti-container"></div>
     <div id="calendar-tooltip" class="calendar-tooltip"></div>

    <script>
        // Início do listener DOMContentLoaded
        document.addEventListener('DOMContentLoaded', async () => {
            // --- i18n Setup ---
            const SUPPORTED_LANGUAGES = ['pt-BR', 'en', 'es', 'de', 'fr', 'it'];
            const DEFAULT_LANGUAGE = 'en'; // Fallback language
            const LANG_STORAGE_KEY = 'jw_assignments_language_preference';
            let translations = {};
            let currentLanguage = DEFAULT_LANGUAGE;

            async function loadTranslations() {
                try {
                    const response = await fetch('translations.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    translations = await response.json();
                    console.log("Translations loaded successfully.");
                } catch (error) {
                    console.error("Could not load translations file (translations.json):", error);
                     translations['en'] = { // Hardcoded basic English fallback
                        pageTitle: "My Assignments", loading: "Loading...", noAssignmentsAdded: "No assignments added yet.",
                        formTypeSelectOption: "Select Type", assignTypeCustom: "Custom", assignCatOther: "Other/Custom",
                        frequentAssignmentsGroup:"Most Used", upcomingTitle:"Next 7 Days", addAssignmentHeader:"Add New",
                        allAssignmentsHeader: "All Assignments", formTypeLabel:"Type", formCustomTypeLabel: "Name",
                        formDateLabel: "Date", formNotesLabel: "Notes", formAddButton: "Add", prevWeekButton: "< Prev",
                        nextWeekButton: "Next >", modalEditButton: "Edit", modalDeleteButton: "Delete", modalCancelButton: "Cancel",
                        modalSaveButton:"Save", modalMarkCompleteButton:"Mark Complete", modalUnmarkCompleteButton:"Unmark Complete",
                        relativeDateToday: "Today", relativeDateTomorrow: "Tomorrow", dayMonShort: "Mon", dayTueShort:"Tue",
                        dayWedShort: "Wed", dayThuShort: "Thu", dayFriShort: "Fri", daySatShort: "Sat", daySunShort: "Sun",
                        calendarThisWeek: "This Week", calendarNextWeek: "Next Week", noUpcomingAssignments:"No items for {0} days.",
                        celebrationTypeName: "Memorial", celebrationNotes:"Annual", assignTypeConvention: "Convention", congressDuration: "3 days",
                        congressDayPrefix: "Conv. (Day {0})", // Add essential assignment type fallbacks too if needed
                        assignCatPreparation:"Preparation", assignCatMeeting:"Meeting", assignCatEvents:"Events", assignTypePresident:"Chairman",
                         alertDateRequired: "Date is required.", alertInvalidDateFormat: "Invalid date format.",
                         alertDateInPast: "Cannot select a past date.", alertAddCelebrationManual: "Memorial is added automatically.",
                         alertInvalidTypeDate:"Please select a valid type and date.", alertAlreadyExists:"'{0}' already exists for {1}.",
                         alertCustomTypeRequired:"Please enter a name for the custom type.", alertCongressExists: "Convention already scheduled starting {0}.",
                         alertCongressDateRequired:"Select FIRST day of convention.", alertErrorAddingCongress:"Error adding convention days.",
                         alertInvalidDate:"Invalid date.", alertDateInPastEdit:"Cannot set past date for incomplete item.",
                         modalCompleteCelebrationFuture:"Cannot complete future Memorial."
                    };
                    currentLanguage = DEFAULT_LANGUAGE;
                    console.warn("Using internal English fallbacks for translations.");
                }
            }

            function getBestInitialLanguage() {
                const savedLang = localStorage.getItem(LANG_STORAGE_KEY);
                if (savedLang && SUPPORTED_LANGUAGES.includes(savedLang)) return savedLang;
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang) {
                   if (SUPPORTED_LANGUAGES.includes(browserLang)) return browserLang;
                   const baseLang = browserLang.split('-')[0];
                   const matchedLang = SUPPORTED_LANGUAGES.find(l => l.startsWith(baseLang));
                   if (matchedLang) return matchedLang;
                }
                return DEFAULT_LANGUAGE;
            }

            function _t(key, ...args) {
                const langSet = (translations && translations[currentLanguage]) || (translations && translations[DEFAULT_LANGUAGE]) || {};
                let translated = langSet[key] !== undefined ? langSet[key] : key; // Use key if translation missing
                if (args.length > 0 && typeof translated === 'string') {
                    args.forEach((arg, index) => {
                        const placeholder = new RegExp(`\\{${index}\\}`, 'g');
                        translated = translated.replace(placeholder, arg ?? ''); // Replace with empty string if arg is null/undefined
                    });
                }
                return translated;
            }

            function applyTranslationsHTML() {
                document.querySelectorAll('[data-translate]').forEach(el => { el.textContent = _t(el.getAttribute('data-translate')); });
                document.querySelectorAll('[data-translate-placeholder]').forEach(el => { el.placeholder = _t(el.getAttribute('data-translate-placeholder')); });
                document.querySelectorAll('[data-translate-title]').forEach(el => { el.title = _t(el.getAttribute('data-translate-title')); });
                if (document.titleElement) { document.title = _t(document.titleElement.getAttribute('data-translate') || 'pageTitle'); }
                document.documentElement.lang = currentLanguage.split('-')[0];
            }

             function setLanguage(lang) {
                 if (!translations || Object.keys(translations).length === 0) { console.warn("Translations not loaded, cannot change language yet."); return; }
                if (SUPPORTED_LANGUAGES.includes(lang) && lang !== currentLanguage) { // Only proceed if changing lang
                    currentLanguage = lang;
                    localStorage.setItem(LANG_STORAGE_KEY, lang);
                    console.log(`Language set to: ${lang}`);
                    initializeAppLogic(); // Re-initialize all dynamic parts
                } else if (!SUPPORTED_LANGUAGES.includes(lang)) {
                    console.warn(`Unsupported language: ${lang}. Sticking with ${currentLanguage}`);
                }
            }
            // --- End i18n Setup ---


            // --- Application Variables ---
            const assignmentForm = document.getElementById('assignmentForm');
            const assignmentTypeInput = document.getElementById('assignmentType');
            const assignmentDateInput = document.getElementById('assignmentDate');
            const assignmentNotesInput = document.getElementById('assignmentNotes');
            const assignmentsListContainer = document.querySelector('#listSection .section-content ul');
            const upcomingList = document.getElementById('upcomingList');
            const customTypeGroup = document.getElementById('customTypeGroup');
            const customAssignmentTypeInput = document.getElementById('customAssignmentType');
            const weeklyCalendarGrid = document.getElementById('weeklyCalendar');
            const actionModal = document.getElementById('actionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalAssignmentIdInput = document.getElementById('modalAssignmentId');
            const modalActionButtonsDiv = actionModal.querySelector('.action-buttons');
            const modalEditViewDiv = actionModal.querySelector('.edit-view');
            const modalEditDateInput = document.getElementById('modalEditDate');
            const modalEditNotesInput = document.getElementById('modalEditNotes');
            const modalBtnComplete = document.getElementById('modalBtnComplete');
            const modalBtnEdit = document.getElementById('modalBtnEdit');
            const modalBtnDelete = document.getElementById('modalBtnDelete');
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const calendarWeekLabel = document.getElementById('calendarWeekLabel');
            const confettiContainer = document.getElementById('confetti-container');
            const calendarTooltip = document.getElementById('calendar-tooltip');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const themeToggleIcon = themeToggleBtn?.querySelector('i'); // Safer access
            document.titleElement = document.querySelector('title');

            // --- Application Constants ---
            const ASSIGNMENTS_STORAGE_KEY = 'jw_assignments_data_v2_multi';
            const THEME_STORAGE_KEY = 'jw_assignments_theme_preference';
            const UPCOMING_DAYS = 7;
            const TOP_N_FREQUENT = 5;
            const CONFETTI_COUNT = 50;
            const CELEBRATION_DATES = [ { date: '2026-04-02', year: 2026 }, { date: '2027-03-22', year: 2027 }, /* Add more */ ];
            const INTERNAL_CELEBRATION_TYPE = "celebration";
            const INTERNAL_CONGRESS_TYPE = "convention";
             // Make sure these keys match the keys used in translations.json
            const BASE_ASSIGNMENT_KEYS = {
                 assignCatPreparation: ["assignTypePresident", "assignTypeFieldLeader", "assignTypeAttendantEntry", "assignTypeAttendantAud", "assignTypeCleaning", "assignTypeAudio", "assignTypeVideo"],
                 assignCatMeeting: ["assignTypeConductor", "assignTypeBibleReading", "assignTypeCongStudyReader", "assignTypeCongStudyConductor", "assignTypePublicTalk", "assignTypeChristianLifeTalk", "assignTypeTreasuresTalk", "assignTypeSpiritualGems", "assignTypeMinistrySchool", "assignTypeWatchtowerReader", "assignTypeWatchtowerConductor", "assignTypeFinalPrayer"],
                 assignCatEvents: ["assignTypeAssembly", INTERNAL_CONGRESS_TYPE, "assignTypeBethelVisit"],
                 assignCatOther: ["assignTypeCustom"]
            };
            const ASSIGNMENT_EMOJIS = { "assignTypePresident": "🧑‍⚖️", "assignTypeFieldLeader": "🗺️", "assignTypeAttendantEntry": "🚪", "assignTypeAttendantAud": "🏛️", "assignTypeCleaning": "🧹", "assignTypeAudio": "🔊", "assignTypeVideo": "📽️", "assignTypeConductor": "🎤", "assignTypeBibleReading": "📖", "assignTypeCongStudyReader": "🤓", "assignTypeCongStudyConductor": "🧑‍🏫", "assignTypePublicTalk": "🗣️", "assignTypeChristianLifeTalk": "💖", "assignTypeTreasuresTalk": "💎", "assignTypeSpiritualGems": "✨", "assignTypeMinistrySchool": "💪", "assignTypeWatchtowerReader": "👀", "assignTypeWatchtowerConductor": "🧐", "assignTypeFinalPrayer": "🙏", "assignTypeAssembly": "🏟️", [INTERNAL_CONGRESS_TYPE]: "🧑‍🤝‍🧑", "convention_day_1": "🧑‍🤝‍🧑", "convention_day_2": "🧑‍🤝‍🧑", "convention_day_3": "🧑‍🤝‍🧑", "assignTypeBethelVisit": "🏢", "assignTypeCustom": "❓", [INTERNAL_CELEBRATION_TYPE]: "🍷", "custom": "✨" };
            const SHORT_ASSIGNMENT_NAME_KEYS = { "assignTypeCongStudyReader": "shortNameCongStudyReader", "assignTypeCongStudyConductor": "shortNameCongStudyConductor", "assignTypeMinistrySchool": "shortNameMinistrySchool", "assignTypeAttendantEntry": "shortNameAttendantEntry", "assignTypeAttendantAud": "shortNameAttendantAud", "assignTypeTreasuresTalk": "shortNameTreasuresTalk", "assignTypeChristianLifeTalk": "shortNameChristianLifeTalk", "assignTypeWatchtowerReader": "shortNameWatchtowerReader", "assignTypeWatchtowerConductor": "shortNameWatchtowerConductor", "convention_day_1": "shortNameConventionD1", "convention_day_2": "shortNameConventionD2", "convention_day_3": "shortNameConventionD3", "assignTypeFieldLeader": "shortNameFieldLeader" };

            // --- Application State ---
            let appData = { assignments: [], frequency: {} };
            let calendarWeekOffset = 0;
            let activeTooltipMarker = null;

             // --- Core Functions ---
             // Includes migration logic now
            function loadAppData(){
                 const s=localStorage.getItem(ASSIGNMENTS_STORAGE_KEY);
                 appData = { assignments: [], frequency: {} }; // Reset before loading
                 if(s){
                     try{
                        const p=JSON.parse(s);
                        if(p && Array.isArray(p.assignments)) appData.assignments = p.assignments;
                         if(p && typeof p.frequency === 'object' && p.frequency !== null) appData.frequency = p.frequency;

                        // Data migration/validation after loading
                         appData.assignments = appData.assignments.map(a => {
                             if (!a) return null; // Filter out null/undefined items

                             if (!a.internalType) {
                                 console.warn("Assignment missing internalType, attempting migration:", a.type || a.id);
                                 if (a.isCelebration) {
                                     a.internalType = INTERNAL_CELEBRATION_TYPE;
                                 } else if (typeof a.type === 'string' && (a.type.includes('Congresso') || a.type.includes('Convention') || a.type.includes('Asamblea') || a.type.includes('Kongress') || a.type.includes('Assemblée'))) { // Wider heuristic
                                     // Try matching based on day number if present
                                     if (a.type.includes('1')) a.internalType = "convention_day_1";
                                     else if (a.type.includes('2')) a.internalType = "convention_day_2";
                                     else if (a.type.includes('3')) a.internalType = "convention_day_3";
                                      else a.internalType = "convention"; // Fallback to main key if no day match
                                 } else {
                                     // Try matching standard type based on display text (less reliable)
                                      let possibleKey = null;
                                      // Create a temporary map of translated names -> keys
                                      const typeMap = {};
                                      for (const catKey in BASE_ASSIGNMENT_KEYS) {
                                          if (Array.isArray(BASE_ASSIGNMENT_KEYS[catKey])) {
                                               BASE_ASSIGNMENT_KEYS[catKey].forEach(typeK => {
                                                  if(typeK !== INTERNAL_CONGRESS_TYPE && typeK !== 'assignTypeCustom') {
                                                       typeMap[_t(typeK)] = typeK; // Map translated name to key
                                                  }
                                               });
                                          }
                                      }
                                      possibleKey = typeMap[a.type]; // Look up the old display type
                                       a.internalType = possibleKey || `custom:${a.type || `unknown_${a.id}`}`; // Fallback to custom
                                       if (!possibleKey) console.log(` > Migrated '${a.type}' to custom type.`);
                                 }
                             }

                             // Update display names based on current language using internal key
                             if (a.internalType && a.internalType !== 'unknown' && !a.internalType.startsWith('custom:')) {
                                if (a.internalType === INTERNAL_CELEBRATION_TYPE) a.type = _t("celebrationTypeName");
                                else if (a.internalType === 'convention_day_1') a.type = _t("congressDayPrefix", 1);
                                else if (a.internalType === 'convention_day_2') a.type = _t("congressDayPrefix", 2);
                                else if (a.internalType === 'convention_day_3') a.type = _t("congressDayPrefix", 3);
                                 // Check if key exists in standard lists before translating
                                 else if (Object.values(BASE_ASSIGNMENT_KEYS).flat().includes(a.internalType)) {
                                     a.type = _t(a.internalType);
                                 } else {
                                     // console.warn("Unknown internal type for re-translation:", a.internalType);
                                     // Leave a.type as is, or set to internal type?
                                 }
                              } else if (a.internalType && a.internalType.startsWith('custom:')) {
                                  // If somehow display 'type' got lost for custom, restore from key
                                  if (!a.type) a.type = a.internalType.substring(7).replace(/_/g, ' ');
                              }

                             return a;
                         }).filter(a => a && a.internalType !== 'unknown'); // Filter out invalid items

                          // Ensure Celebrations are correctly flagged if only internalType was migrated
                          appData.assignments.forEach(a => { if (a.internalType === INTERNAL_CELEBRATION_TYPE) a.isCelebration = true; });

                    } catch(e){ console.error("Error parsing loaded data:", e); appData = { assignments: [], frequency: {} }; /* Reset on critical error */ }
                 }
            }

            function saveAppData(){ try{localStorage.setItem(ASSIGNMENTS_STORAGE_KEY,JSON.stringify(appData));} catch(e){console.error("Failed to save data:", e);}}
            function loadThemePreference() { const savedTheme = localStorage.getItem(THEME_STORAGE_KEY); if (savedTheme === 'light') { document.body.classList.add('light-theme'); if (themeToggleIcon) { themeToggleIcon.classList.remove('fa-sun'); themeToggleIcon.classList.add('fa-moon'); } } else { document.body.classList.remove('light-theme'); if (themeToggleIcon) { themeToggleIcon.classList.remove('fa-moon'); themeToggleIcon.classList.add('fa-sun'); } } }
            function saveThemePreference(theme) { localStorage.setItem(THEME_STORAGE_KEY, theme); }
            function toggleTheme() { const isLight = document.body.classList.toggle('light-theme'); saveThemePreference(isLight ? 'light' : 'dark'); if (themeToggleIcon) { themeToggleIcon.classList.toggle('fa-sun', !isLight); themeToggleIcon.classList.toggle('fa-moon', isLight); }}

            function getEmojiForInternalType(internalType){ if (internalType?.startsWith('custom:')) return ASSIGNMENT_EMOJIS['custom'] || '✨'; return ASSIGNMENT_EMOJIS[internalType] || ASSIGNMENT_EMOJIS['assignTypeCustom'] ||'❓';}
            function formatDate(d,o={day:'2-digit',month:'2-digit',year:'numeric'}){if(!d)return '';try{const dt=new Date(`${d}T00:00:00Z`); if(isNaN(dt)) throw new Error("Invalid date input for Date obj"); return new Intl.DateTimeFormat(currentLanguage,{...o,timeZone:'UTC'}).format(dt);}catch(e){console.error("Date format error:",e, "Input:", d); const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d;}}
            function dateToYyyyMmDd(d){ try{ if (!(d instanceof Date)) d = new Date(d); if(isNaN(d)) throw new Error("Invalid Date obj"); const year = d.getUTCFullYear(); const month = String(d.getUTCMonth()+1).padStart(2,'0'); const day = String(d.getUTCDate()).padStart(2,'0'); return`${year}-${month}-${day}`; } catch(e) { console.error("dateToYyyyMmDd error:", e, "Input:", d); return null;} }
            function getTodayDateString(){const d=new Date(); return dateToYyyyMmDd(d);}

             // --- CORRECTED formatRelativeDate function ---
             function formatRelativeDate(ds) {
                if (!ds || !/^\d{4}-\d{2}-\d{2}$/.test(ds)) { return ds || ''; } // Basic validation
                try { // <<< OUTER TRY BLOCK STARTS HERE
                    const today = new Date();
                    today.setUTCHours(0, 0, 0, 0);
                    const targetDate = new Date(`${ds}T00:00:00Z`);
                    if (isNaN(targetDate.getTime())) {
                        console.warn("formatRelativeDate: Invalid targetDate from input", ds);
                        return ds; // Return original string if date is invalid
                    }

                    // Check if Intl.RelativeTimeFormat is supported
                    if (typeof Intl !== 'undefined' && typeof Intl.RelativeTimeFormat !== 'undefined') {
                        const rtf = new Intl.RelativeTimeFormat(currentLanguage, { numeric: 'auto', style: 'short' });
                        const diffDays = Math.ceil((targetDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));

                        if (diffDays < -30) return formatDate(ds); // Show full date if long past
                        if (diffDays < 0) return rtf.format(diffDays, 'day'); // "X days ago" etc.
                        if (diffDays === 0) return _t("relativeDateToday");
                        if (diffDays === 1) return _t("relativeDateTomorrow");

                        if (diffDays > 1 && diffDays <= 6) {
                            // Try showing "in X days (Weekday)"
                            try { // <<< INNER TRY
                                const weekdayFormat = new Intl.DateTimeFormat(currentLanguage, { weekday: 'short', timeZone: 'UTC' });
                                const weekday = weekdayFormat.format(targetDate);
                                return `${rtf.format(diffDays, 'day')} (${weekday})`;
                            } catch (eInner) { // <<< INNER CATCH
                                console.warn("formatRelativeDate: Could not format weekday, falling back.", eInner);
                                // Fallback if weekday formatting fails
                                return rtf.format(diffDays, 'day');
                            } // <<< INNER TRY/CATCH ENDS
                        }
                        // For dates further out (>6 days), just show month/day
                        return formatDate(ds, { day: '2-digit', month: 'short' });
                    } else {
                         // Fallback if Intl.RelativeTimeFormat is not supported (older browsers)
                         return formatDate(ds);
                    }

                } catch (e) { // <<< ****** CATCH BLOCK FOR OUTER TRY ******
                    console.error("Error in formatRelativeDate:", e, "Input:", ds);
                    return formatDate(ds); // Fallback to default format on any unexpected error
                } // <<< OUTER TRY/CATCH ENDS
             }
             // --- End CORRECTED formatRelativeDate function ---


             function updateFrequency(internalType) { if (!internalType) return; if (internalType !== 'assignTypeCustom' && !internalType.startsWith('custom:') && !internalType.startsWith('convention_day_') && internalType !== INTERNAL_CELEBRATION_TYPE) { appData.frequency[internalType] = (appData.frequency[internalType] || 0) + 1; } else if (internalType === INTERNAL_CONGRESS_TYPE) { appData.frequency[INTERNAL_CONGRESS_TYPE] = (appData.frequency[INTERNAL_CONGRESS_TYPE] || 0) + 1; }}
             function triggerConfetti(){const c=['var(--accent-primary-color)','var(--accent-alt-color)','var(--success-color)','var(--error-color)','var(--list-color-1)','var(--list-color-3)','var(--list-color-5)'];if(!confettiContainer) return; for(let i=0;i<CONFETTI_COUNT;i++){const p=document.createElement('div');p.classList.add('confetti-piece');p.style.background=c[Math.floor(Math.random()*c.length)];p.style.left=Math.random()*100+'vw';p.style.top=-10-Math.random()*30+'px';p.style.animationDuration=2.5+Math.random()*1.5+'s';p.style.animationDelay=Math.random()*0.5+'s';p.style.transform=`rotate(${Math.random()*360}deg) scale(${0.8+Math.random()*0.4})`;confettiContainer.appendChild(p);setTimeout(()=>{p.remove();},4500);}}
             function getNextCelebrationDate(todayStr) { if(!todayStr) return null; const today = new Date(todayStr + 'T00:00:00Z'); for (const cel of CELEBRATION_DATES) { if (cel && cel.date) { const celDate = new Date(cel.date + 'T00:00:00Z'); if (!isNaN(celDate) && celDate >= today) { return cel; } } } return CELEBRATION_DATES.length > 0 ? CELEBRATION_DATES[CELEBRATION_DATES.length - 1] : null; }

            function ensureCelebrationExists() {
                const todayStr = getTodayDateString(); if (!todayStr) return;
                const nextCelebration = getNextCelebrationDate(todayStr);
                let existingCelebration = appData.assignments.find(a => a && a.internalType === INTERNAL_CELEBRATION_TYPE);
                let needsSave = false;
                 if (!nextCelebration) return;
                 const celebrationId = `celebration-${nextCelebration.year}`;

                 if (existingCelebration) {
                    if (existingCelebration.date !== nextCelebration.date || existingCelebration.id !== celebrationId || existingCelebration.type !== _t("celebrationTypeName")) {
                        existingCelebration.date = nextCelebration.date; existingCelebration.id = celebrationId; existingCelebration.type = _t("celebrationTypeName");
                         if (!existingCelebration.id.endsWith(String(nextCelebration.year))) { existingCelebration.completed = false; }
                        needsSave = true;
                    }
                 } else {
                     appData.assignments.push({ id: celebrationId, type: _t("celebrationTypeName"), internalType: INTERNAL_CELEBRATION_TYPE, date: nextCelebration.date, notes: _t("celebrationNotes"), completed: false, isCelebration: true });
                    needsSave = true;
                 }
                 if (needsSave) saveAppData();
            }

             function updateDropdownOrder() {
                 const select = assignmentTypeInput; if (!select) return;
                 const currentSelection = select.value;
                 select.innerHTML = `<option value="" disabled selected>${_t("formTypeSelectOption")}</option>`;
                 let allOptions = [];
                  if (!BASE_ASSIGNMENT_KEYS || typeof BASE_ASSIGNMENT_KEYS !== 'object') { console.error("BASE_ASSIGNMENT_KEYS missing or invalid"); return; }

                  Object.keys(BASE_ASSIGNMENT_KEYS).forEach(categoryKey => {
                    if (Array.isArray(BASE_ASSIGNMENT_KEYS[categoryKey])) {
                         BASE_ASSIGNMENT_KEYS[categoryKey].forEach(typeKey => {
                            if (typeKey !== 'assignTypeCustom') {
                                let displayText = typeKey === INTERNAL_CONGRESS_TYPE
                                    ? `${getEmojiForInternalType(typeKey)} ${_t('assignTypeConvention')} (${_t('congressDuration')})`
                                    : `${getEmojiForInternalType(typeKey)} ${_t(typeKey)}`;
                                allOptions.push({ internalValue: typeKey, displayText: displayText, categoryKey: categoryKey, freq: appData.frequency[typeKey] || 0 });
                            }
                         });
                    }
                  });

                 allOptions.sort((a, b) => (b.freq !== a.freq) ? b.freq - a.freq : (a.displayText || "").localeCompare(b.displayText || "", currentLanguage));

                 const topFreqInternalValues = allOptions.slice(0, TOP_N_FREQUENT).filter(o => o.freq > 0).map(o => o.internalValue);
                 const addedFreq = new Set();

                 if (topFreqInternalValues.length > 0) {
                     const fg = document.createElement('optgroup'); fg.label = _t("frequentAssignmentsGroup"); fg.className = 'frequent-group';
                     allOptions.forEach(o => { if (topFreqInternalValues.includes(o.internalValue)) { const op = document.createElement('option'); op.value = o.internalValue; op.textContent = o.displayText; fg.appendChild(op); addedFreq.add(o.internalValue); }});
                     if (fg.childElementCount > 0) select.appendChild(fg);
                 }

                  Object.keys(BASE_ASSIGNMENT_KEYS).forEach(categoryKey => {
                      const grp = document.createElement('optgroup'); grp.label = _t(categoryKey); let hasOpt = false;
                      const categoryOptions = allOptions.filter(o => o.categoryKey === categoryKey && !addedFreq.has(o.internalValue)).sort((a, b) => (a.displayText || "").localeCompare(b.displayText || "", currentLanguage));
                      categoryOptions.forEach(o => { const op = document.createElement('option'); op.value = o.internalValue; op.textContent = o.displayText; grp.appendChild(op); hasOpt = true; });
                      if (categoryKey === 'assignCatOther') { const custOpt = document.createElement('option'); custOpt.value = 'assignTypeCustom'; custOpt.textContent = `${getEmojiForInternalType('assignTypeCustom')} ${_t('assignTypeCustom')}`; grp.appendChild(custOpt); hasOpt = true; }
                      if (hasOpt) select.appendChild(grp);
                  });

                  if (Array.from(select.options).some(opt => opt.value === currentSelection)) { select.value = currentSelection; } else if (select.options.length > 0) { select.options[0].selected = true; }
                 select.dispatchEvent(new Event('change'));
             }

            function renderWeeklyCalendar(){
                if (!weeklyCalendarGrid || !calendarWeekLabel || !prevWeekBtn || !nextWeekBtn) return;
                 weeklyCalendarGrid.innerHTML=''; hideCalendarTooltip();
                 const today=new Date(); today.setUTCHours(0,0,0,0); const baseWeek=new Date(today); baseWeek.setUTCDate(today.getUTCDate()+(calendarWeekOffset*7));
                 const dow=(baseWeek.getUTCDay() + 6) % 7; const start=new Date(baseWeek); start.setUTCDate(baseWeek.getUTCDate()-dow); start.setUTCHours(0,0,0,0);
                 const end=new Date(start); end.setUTCDate(start.getUTCDate()+6); const todayStr = getTodayDateString();

                if(calendarWeekOffset===0) calendarWeekLabel.textContent = _t("calendarThisWeek");
                else if(calendarWeekOffset===1) calendarWeekLabel.textContent = _t("calendarNextWeek");
                else calendarWeekLabel.textContent=`${formatDate(dateToYyyyMmDd(start),{day:'2-digit',month:'short'})} - ${formatDate(dateToYyyyMmDd(end),{day:'2-digit',month:'short'})}`;

                 prevWeekBtn.disabled = false; nextWeekBtn.disabled = false;

                 const dayNames = [_t("dayMonShort"), _t("dayTueShort"), _t("dayWedShort"), _t("dayThuShort"), _t("dayFriShort"), _t("daySatShort"), _t("daySunShort")];
                 dayNames.forEach(h=>{const d=document.createElement('div');d.className='day-header';d.textContent=h;weeklyCalendarGrid.appendChild(d);});

                 for(let i=0;i<7;i++){
                    const currentDate = new Date(start); currentDate.setUTCDate(start.getUTCDate()+i); const dateStr = dateToYyyyMmDd(currentDate); if (!dateStr) continue;
                    const cellElement = document.createElement('div'); cellElement.className='day-cell'; if(dateStr===todayStr) cellElement.classList.add('today');
                    const numberSpan=document.createElement('span'); numberSpan.className='day-number'; numberSpan.textContent=currentDate.getUTCDate(); cellElement.appendChild(numberSpan);
                    const assignmentsUl = document.createElement('ul'); assignmentsUl.className='day-assignments'; cellElement.appendChild(assignmentsUl);
                    const todaysAssignments = appData.assignments.filter(a => a && a.date === dateStr && !a.completed); // Add check for `a` existence

                    todaysAssignments.forEach(a => {
                        if (!a.internalType) return;
                        const li = document.createElement('li'); li.className = 'assignment-marker';
                        const shortNameKey = SHORT_ASSIGNMENT_NAME_KEYS[a.internalType];
                        const shortName = shortNameKey ? _t(shortNameKey) : (a.type || _t(a.internalType));
                        li.textContent = shortName; li.dataset.fullName = a.type || _t(a.internalType);
                        if (a.notes) { li.dataset.notes = a.notes; } li.dataset.internalType = a.internalType;
                        assignmentsUl.appendChild(li);
                    });
                    weeklyCalendarGrid.appendChild(cellElement);
                 }
            }

             function renderUpcomingList(){
                if (!upcomingList) return;
                 upcomingList.innerHTML=''; const today=new Date();today.setUTCHours(0,0,0,0); const cutoff=new Date(today); cutoff.setUTCDate(today.getUTCDate()+UPCOMING_DAYS); const todayStr = getTodayDateString();
                 const upcoming=appData.assignments.filter(a=>{ try { const d = new Date(a.date+'T00:00:00Z'); return a && a.date && !isNaN(d) && d >= today && d < cutoff && !a.completed && a.date >= todayStr && a.internalType; } catch(e){ return false; } }).sort((a,b) => { try{ return new Date(a.date+'T00:00:00Z') - new Date(b.date+'T00:00:00Z');} catch(e) {return 0;} });
                 if(upcoming.length===0){upcomingList.innerHTML=`<li class="no-upcoming">${_t("noUpcomingAssignments", UPCOMING_DAYS)}</li>`;}
                 else { upcoming.forEach(a=>{ const li=document.createElement('li');li.className='upcoming-item';const t=document.createElement('span');t.className='type';t.textContent=`${getEmojiForInternalType(a.internalType)} ${a.type || _t(a.internalType)}`;const dt=document.createElement('span');dt.className='date';dt.textContent=formatRelativeDate(a.date);li.appendChild(t);li.appendChild(dt);upcomingList.appendChild(li); });}
             }

            function renderAssignments() {
                const container = assignmentsListContainer; if (!container) return;
                 container.innerHTML = '';
                 if (!appData?.assignments || appData.assignments.length === 0) { container.innerHTML = `<li class="no-assignments">${_t("noAssignmentsAdded")}</li>`; return; }

                const sorted = [...appData.assignments].filter(a => a && a.internalType) // Ensure item and internalType exist
                    .sort((a,b)=>{
                    const timeA = a.date ? new Date(a.date+'T00:00:00Z').getTime() : (a.completed ? Infinity : -Infinity); // Handle potentially missing date
                    const timeB = b.date ? new Date(b.date+'T00:00:00Z').getTime() : (b.completed ? Infinity : -Infinity);
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    if (isNaN(timeA) && isNaN(timeB)) return 0; // If both dates invalid, keep order
                    if (isNaN(timeA)) return a.completed ? 1 : -1; // Invalid dates go last if completed, first if not
                    if (isNaN(timeB)) return b.completed ? -1 : 1;
                    if (timeA !== timeB) return timeA - timeB;
                    return (a.type || "").localeCompare(b.type || "", currentLanguage);
                });

                if (sorted.length === 0) { container.innerHTML = `<li class="no-assignments">${_t("noAssignmentsAdded")}</li>`; return; }

                sorted.forEach(a => {
                    const li = document.createElement('li'); li.className = 'assignment-item'; li.dataset.id = a.id;
                    if (a.isCelebration) li.dataset.iscelebration = "true"; if (a.completed) li.classList.add('is-completed');
                    const emojiSpan = document.createElement('span'); emojiSpan.className = 'assignment-emoji'; emojiSpan.textContent = getEmojiForInternalType(a.internalType); li.appendChild(emojiSpan);
                    const typeSpan = document.createElement('span'); typeSpan.className = 'assignment-type'; typeSpan.textContent = a.type || _t(a.internalType); li.appendChild(typeSpan);
                    const dateSpan = document.createElement('span'); dateSpan.className = 'assignment-date'; dateSpan.textContent = formatRelativeDate(a.date); li.appendChild(dateSpan);
                    if (a.notes && !a.isCelebration) { const notesSpan = document.createElement('span'); notesSpan.className = 'assignment-notes'; notesSpan.textContent = `(${a.notes})`; li.appendChild(notesSpan); }
                    else if (a.isCelebration && a.date){ try { const year = new Date(a.date + 'T00:00:00Z').getUTCFullYear(); if (!isNaN(year)) { const yearSpan = document.createElement('span'); yearSpan.className = 'assignment-notes'; yearSpan.textContent = `(${year})`; li.appendChild(yearSpan); }} catch (e) {} }
                    li.addEventListener('click', (e) => { const item = e.currentTarget; if (item?.dataset?.id) showActionModal(item.dataset.id); });
                    container.appendChild(li);
                });
            }

             function addAssignment(event){
                event.preventDefault();
                if (!assignmentTypeInput || !assignmentDateInput || !customAssignmentTypeInput) return;

                const internalTypeSelected = assignmentTypeInput.value; const selectedOptionElement = assignmentTypeInput.options[assignmentTypeInput.selectedIndex];
                const displayTypeSelected = selectedOptionElement ? selectedOptionElement.textContent : internalTypeSelected;
                const baseDateString = assignmentDateInput.value; const notes = assignmentNotesInput?.value.trim() || '';
                let finalInternalType = internalTypeSelected; let finalDisplayType = displayTypeSelected; let frequencyTrackingType = internalTypeSelected;
                const todayS = getTodayDateString();
                const emojiMatch = displayTypeSelected.match(/^(\p{Emoji}\uFE0F?)\s+/u); let cleanDisplayTypeForAlert = emojiMatch ? displayTypeSelected.substring(emojiMatch[0].length) : displayTypeSelected;
                cleanDisplayTypeForAlert = cleanDisplayTypeForAlert.replace(` (${_t('congressDuration')})`, '').trim();

                // --- Validations ---
                if (internalTypeSelected === INTERNAL_CELEBRATION_TYPE) { alert(_t("alertAddCelebrationManual")); return; }
                if (!baseDateString) { alert(_t("alertDateRequired")); assignmentDateInput.focus(); return; }
                if (!/^\d{4}-\d{2}-\d{2}$/.test(baseDateString)) { alert(_t('alertInvalidDateFormat')); assignmentDateInput.focus(); return; }
                if (baseDateString < todayS) { alert(_t("alertDateInPast")); assignmentDateInput.focus(); return; }

                // --- Type Specific Logic ---
                 if (internalTypeSelected === 'assignTypeCustom') {
                    const customName = customAssignmentTypeInput.value.trim(); if (!customName) { alert(_t("alertCustomTypeRequired")); customAssignmentTypeInput.focus(); return; }
                    finalInternalType = 'custom:' + customName.toLowerCase().replace(/[^\p{L}\p{N}_-]+/gu, '_').substring(0, 30); // Better key sanitization
                    finalDisplayType = customName; frequencyTrackingType = null;
                    const customExists = appData.assignments.some(a => a && a.type === finalDisplayType && a.date === baseDateString && !a.completed);
                    if (customExists) { alert(_t("alertAlreadyExists", finalDisplayType, formatDate(baseDateString))); return; }
                 } else if (internalTypeSelected === INTERNAL_CONGRESS_TYPE) {
                     const day1InternalType = `convention_day_1`; const day1Exists = appData.assignments.some(a => a && a.internalType === day1InternalType && a.date === baseDateString);
                     if (day1Exists) { alert(_t("alertCongressExists", formatDate(baseDateString))); return; }
                     const startDate = new Date(`${baseDateString}T00:00:00Z`); if (isNaN(startDate)) { alert(_t('alertInvalidDate')); return; }
                     let addedAssignments = [];
                     for (let i = 0; i < 3; i++) { const currentDayDate = new Date(startDate); currentDayDate.setUTCDate(startDate.getUTCDate() + i); const currentDayDateString = dateToYyyyMmDd(currentDayDate); if (!currentDayDateString) { alert(_t("alertErrorAddingCongress")); return; } const dayTypeDisplay = _t('congressDayPrefix', i + 1); const dayTypeInternal = `convention_day_${i + 1}`; addedAssignments.push({ id: Date.now() + Math.random() + i, type: dayTypeDisplay, internalType: dayTypeInternal, date: currentDayDateString, notes: notes, completed: false, isCelebration: false }); }
                     appData.assignments.push(...addedAssignments); updateFrequency(INTERNAL_CONGRESS_TYPE); saveAppData(); renderAll(); resetAndCloseForm(); return;
                 } else { // Standard type
                     if (!internalTypeSelected) { alert(_t('alertInvalidTypeDate')); assignmentTypeInput.focus(); return; }
                     finalDisplayType = _t(internalTypeSelected); const exists = appData.assignments.some(a => a && a.internalType === internalTypeSelected && a.date === baseDateString && !a.completed);
                     if (exists) { alert(_t("alertAlreadyExists", finalDisplayType, formatDate(baseDateString))); return; }
                 }
                // --- Add Standard or Custom ---
                 const newAssignment = { id: Date.now() + Math.random(), type: finalDisplayType, internalType: finalInternalType, date: baseDateString, notes: notes, completed: false, isCelebration: false };
                 appData.assignments.push(newAssignment); if (frequencyTrackingType) { updateFrequency(frequencyTrackingType); }
                 saveAppData(); renderAll(); resetAndCloseForm();
             }

             function resetAndCloseForm() { if (assignmentForm) assignmentForm.reset(); if (customTypeGroup) customTypeGroup.style.display = 'none'; if (customAssignmentTypeInput) { customAssignmentTypeInput.value = ''; customAssignmentTypeInput.required = false; } if (assignmentTypeInput) assignmentTypeInput.value = ""; toggleSection('formSection', false); }

             // --- Modal & Action Functions ---
            function showActionModal(id){
                 const a=appData.assignments.find(x=>x && x.id == id);
                 if(!a || !actionModal || !modalTitle || !modalBtnComplete || !modalBtnEdit || !modalBtnDelete || !modalAssignmentIdInput ) return;
                 modalAssignmentIdInput.value=id; modalTitle.textContent=`${getEmojiForInternalType(a.internalType)} ${a.type || _t(a.internalType)}`;
                 modalActionButtonsDiv.style.display='flex'; modalEditViewDiv.style.display='none';
                 modalBtnComplete.textContent = a.completed ? _t("modalUnmarkCompleteButton") : _t("modalMarkCompleteButton"); modalBtnComplete.disabled = false; modalBtnComplete.title = '';
                 const canEditDelete = !a.isCelebration && !a.internalType?.startsWith('convention_day_');
                 modalBtnEdit.style.display = canEditDelete ? 'block' : 'none'; modalBtnDelete.style.display = canEditDelete ? 'block' : 'none';
                 modalBtnEdit.disabled = !canEditDelete; modalBtnDelete.disabled = !canEditDelete;
                 if (a.isCelebration){ const todayStr=getTodayDateString(); if(a.date > todayStr){ modalBtnComplete.disabled=true; modalBtnComplete.title = _t("modalCompleteCelebrationFuture"); }}
                 actionModal.classList.add('is-visible');
            }
            function hideActionModal(){ if(actionModal) actionModal.classList.remove('is-visible'); /* Optionally clear fields: modalAssignmentIdInput.value=''; modalEditDateInput.value=''; modalEditNotesInput.value=''; */ }
            function handleCompleteToggle(){ const id=modalAssignmentIdInput.value; const idx=appData.assignments.findIndex(a=>a && a.id==id); if(idx===-1) return; const a=appData.assignments[idx]; if(a.isCelebration){ const todayStr=getTodayDateString(); if(a.date>todayStr){return;}} const willBeCompleted=!a.completed; appData.assignments[idx].completed=willBeCompleted; saveAppData(); renderAll(); if(willBeCompleted){triggerConfetti();} hideActionModal(); }
            function handleEditRequest(){ const id=modalAssignmentIdInput.value; const a=appData.assignments.find(x=>x && x.id==id); if(!a || a.isCelebration || a.internalType?.startsWith('convention_day_') || !modalEditDateInput || !modalEditNotesInput || !modalActionButtonsDiv || !modalEditViewDiv ) return; modalEditDateInput.value=a.date; modalEditNotesInput.value=a.notes||''; modalActionButtonsDiv.style.display='none'; modalEditViewDiv.style.display='flex'; }
            function handleSaveEdit(){ const id=modalAssignmentIdInput.value; const idx=appData.assignments.findIndex(a=>a && a.id==id); if(idx===-1 || appData.assignments[idx].isCelebration || appData.assignments[idx].internalType?.startsWith('convention_day_') || !modalEditDateInput || !modalEditNotesInput) return; const newDate=modalEditDateInput.value; const newNotes=modalEditNotesInput.value.trim(); const todayS=getTodayDateString(); if(!newDate||!/^\d{4}-\d{2}-\d{2}$/.test(newDate)){alert(_t("alertInvalidDate")); modalEditDateInput.focus(); return;} if(newDate < todayS && !appData.assignments[idx].completed){alert(_t("alertDateInPastEdit")); modalEditDateInput.focus(); return;} appData.assignments[idx].date=newDate; appData.assignments[idx].notes=newNotes; saveAppData(); renderAll(); hideActionModal(); }
            function deleteAssignment(id){ const aIndex = appData.assignments.findIndex(x => x && x.id == id); if (aIndex === -1) return; const a = appData.assignments[aIndex]; if (!a || a.isCelebration || a.internalType?.startsWith('convention_day_')) { return; } appData.assignments.splice(aIndex, 1); saveAppData(); renderAll(); }
            function handleDeleteRequest(){ const id = modalAssignmentIdInput.value; if (id) { deleteAssignment(id); hideActionModal(); } }

            function renderAll() {
                 try { // Add safety wrapper around the whole render cycle
                     ensureCelebrationExists();
                     loadAppData(); // Must load after ensureCelebration adds potential new item, and before rendering
                     renderAssignments();
                     renderUpcomingList();
                     renderWeeklyCalendar();
                     updateDropdownOrder();
                     applyTranslationsHTML();
                 } catch (error) {
                     console.error("Critical error during renderAll:", error);
                     // Display a user-friendly error?
                     document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--error-color);">Application error. Please reload. (${error.message})</div>`;
                 }
             }

             // --- UI Helpers ---
             window.toggleSection = (id, forceState = null) => { const el = document.getElementById(id); if(!el) return; const headerIcon = el.querySelector('.section-header i'); const shouldOpen = forceState === null ? !el.classList.contains('is-open') : forceState; el.classList.toggle('is-open', shouldOpen); if (headerIcon) headerIcon.style.transform = shouldOpen ? 'rotate(90deg)' : 'rotate(0deg)'; };

             function showCalendarTooltip(markerElement) {
                 if (!markerElement || !calendarTooltip || !weeklyCalendarGrid ) return;
                 const fullName = markerElement.dataset.fullName; const notes = markerElement.dataset.notes; const internalType = markerElement.dataset.internalType;
                 if (!internalType) return; let content = `${getEmojiForInternalType(internalType)} ${fullName}`; if (notes) { content += ` (${notes})`; }
                 calendarTooltip.textContent = content;
                 const markerRect = markerElement.getBoundingClientRect(); const gridRect = weeklyCalendarGrid.getBoundingClientRect();
                 const dashboardSection = weeklyCalendarGrid.closest('.dashboard-section');
                 const dashRect = dashboardSection?.getBoundingClientRect() || { top: 0, left: 0, right: window.innerWidth }; // Fallback

                 let top = (markerRect.bottom - gridRect.top) + 5 + (dashboardSection?.scrollTop || 0); let left = (markerRect.left - gridRect.top) + (markerRect.width / 2); // Position relative to grid parent

                 calendarTooltip.style.position = 'absolute'; // Ensure it's absolute
                 calendarTooltip.style.top = `${top}px`; calendarTooltip.style.left = `${left}px`; calendarTooltip.style.transform = 'translateX(-50%) translateY(0)';
                 calendarTooltip.classList.add('is-visible'); activeTooltipMarker = markerElement;

                 requestAnimationFrame(() => { // Boundary check after initial render
                       if (!calendarTooltip.classList.contains('is-visible')) return;
                        const tooltipRect = calendarTooltip.getBoundingClientRect();
                        // Check against the DASHBOARD section boundaries, not grid
                         const rightEdge = dashRect.right - 10; const leftEdge = dashRect.left + 10;
                        let newLeft = left; let newTransform = 'translateX(-50%) translateY(0)';

                        if (tooltipRect.right > rightEdge) { newLeft = (rightEdge - dashRect.left) - (tooltipRect.width / 2); } // Adjust left based on container edge
                        else if (tooltipRect.left < leftEdge) { newLeft = (leftEdge - dashRect.left) + (tooltipRect.width / 2); }

                        // Clamp final left position to stay fully within bounds (prevent tiny overflows)
                         const maxLeft = (dashRect.right - dashRect.left) - tooltipRect.width - 10; // Max left offset within parent
                         const minLeft = 10; // Min left offset within parent
                         if(newLeft + (tooltipRect.width * (newTransform.includes('-50%') ? 0.5 : 0)) > maxLeft + 10) newLeft = maxLeft;
                         if(newLeft - (tooltipRect.width * (newTransform.includes('-50%') ? 0.5 : 0)) < minLeft - 10) newLeft = minLeft;

                         calendarTooltip.style.left = `${newLeft}px`;
                         calendarTooltip.style.transform = newTransform;
                   });
                 setTimeout(() => hideCalendarTooltip(markerElement), 3500);
             }
            function hideCalendarTooltip(marker = null) { if (activeTooltipMarker && (marker === null || marker === activeTooltipMarker) && calendarTooltip) { calendarTooltip.classList.remove('is-visible'); activeTooltipMarker = null; }}
            function handleCalendarMarkerClick(event) { const marker = event.target.closest('.assignment-marker'); if (marker) { if(marker === activeTooltipMarker) { hideCalendarTooltip(marker); } else { hideCalendarTooltip(); showCalendarTooltip(marker); } } else if (!event.target.closest('.calendar-tooltip')) { hideCalendarTooltip(); }}

             // --- Initialize App Logic ---
             function initializeAppLogic() {
                if (!translations || Object.keys(translations).length === 0) { console.error("Cannot initialize: Translations not loaded."); document.body.innerHTML = `<p style='padding:20px; color:red;'>Error loading translations. Please ensure 'translations.json' exists and is valid.</p>`; return; }
                console.log("Initializing App Logic with language:", currentLanguage);
                try {
                    renderAll(); // Render everything based on loaded data/language
                     if (assignmentTypeInput) assignmentTypeInput.dispatchEvent(new Event('change'));
                    toggleSection('formSection', false); toggleSection('listSection', true);
                } catch(error) {
                     console.error("Error during initial render:", error);
                      document.body.innerHTML = `<p style='padding:20px; color:red;'>Error initializing application interface.</p>`;
                }
            }

            // --- Global Event Listeners (Setup once) ---
             function setupEventListeners() {
                if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
                if (actionModal) actionModal.addEventListener('click',(e)=>{if(e.target===actionModal){hideActionModal();}});
                if (modalBtnComplete) modalBtnComplete.addEventListener('click',handleCompleteToggle);
                if (modalBtnEdit) modalBtnEdit.addEventListener('click',handleEditRequest);
                if (modalBtnDelete) modalBtnDelete.addEventListener('click',handleDeleteRequest);
                if (document.getElementById('modalBtnCancel')) document.getElementById('modalBtnCancel').addEventListener('click',hideActionModal);
                if (document.getElementById('modalBtnSaveEdit')) document.getElementById('modalBtnSaveEdit').addEventListener('click',handleSaveEdit);
                if (document.getElementById('modalBtnCancelEdit')) document.getElementById('modalBtnCancelEdit').addEventListener('click',hideActionModal);
                window.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&actionModal?.classList.contains('is-visible')){hideActionModal();}});
                if (assignmentTypeInput) assignmentTypeInput.addEventListener('change',()=>{ const isCustom = assignmentTypeInput.value === 'assignTypeCustom'; if (customTypeGroup) customTypeGroup.style.display = isCustom ? 'flex' : 'none'; if(customAssignmentTypeInput){ customAssignmentTypeInput.required = isCustom; if(isCustom){ setTimeout(()=>customAssignmentTypeInput.focus(),50); } else { customAssignmentTypeInput.value=''; }} });
                if (assignmentForm) assignmentForm.addEventListener('submit',addAssignment);
                if (prevWeekBtn) prevWeekBtn.addEventListener('click', () => { calendarWeekOffset--; renderWeeklyCalendar(); });
                if (nextWeekBtn) nextWeekBtn.addEventListener('click', () => { calendarWeekOffset++; renderWeeklyCalendar(); });
                if (weeklyCalendarGrid) weeklyCalendarGrid.addEventListener('click', handleCalendarMarkerClick);
            }


            // --- Initial App Load Sequence ---
             async function initializeApp() {
                 console.log("Starting App Initialization...");
                 loadThemePreference(); // Non-critical, visual only
                 currentLanguage = getBestInitialLanguage();
                 console.log("Initial language determined:", currentLanguage);
                 await loadTranslations(); // Crucial step, wait for it
                 setupEventListeners();   // Setup listeners after elements are known
                 initializeAppLogic();    // Render UI based on translations/data
                 console.log("App Initialized.");
             }

            initializeApp(); // Start the entire process

        }); // --- FIM do listener DOMContentLoaded ---
    </script>
</body>
</html>
