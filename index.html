<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minhas Designa√ß√µes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            /* === TEMA BLACK MIDNIGHT REFINADO === */
            --midnight-bg: #0d0d10; --midnight-surface: #1c1c21; --midnight-surface-lighter: #25252b;
            --midnight-border: #333338; --completed-item-bg: #101012;
            --midnight-text-primary: #eaeaf0; --midnight-text-secondary: #90909c;
            --midnight-accent-primary: #8a9ff9; --midnight-accent-secondary: #5c6db5; --midnight-accent-alt: #f2c079;
            --error-color: #e680a7; --success-color: #74c7a3;
            --list-color-1: #2f588f; --list-color-2: #457c7c; --list-color-3: #7d5c9e;
            --list-color-4: #82a05e; --list-color-5: #bc906d;
            --border-radius-outer: 24px; --border-radius-inner: 10px; --font-family: 'Inter', sans-serif;
            --transition-speed-fast: 0.2s; --transition-speed-med: 0.3s; --transition-speed-slow: 0.5s;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; } html { scroll-behavior: smooth; height: 100%; }
        body { font-family:var(--font-family); background-color: #030304; color:var(--midnight-text-primary); display:flex; justify-content:center; align-items:center; padding:15px; min-height:100vh; -webkit-tap-highlight-color:transparent; position: relative; overflow-x: hidden; }
        .mobile-view-container { background-color:var(--midnight-bg); width:100%; max-width:420px; height:85vh; max-height:800px; border-radius:var(--border-radius-outer); box-shadow:0 20px 50px rgba(0,0,0,0.7), 0 0 0 6px rgba(0,0,0,0.3); display:flex; flex-direction:column; overflow:hidden; z-index: 1; position: relative; border: 1px solid var(--midnight-border); }
        header.main-header { background: linear-gradient(180deg, var(--midnight-surface), var(--midnight-bg)); padding:18px 20px; border-bottom:1px solid var(--midnight-border); flex-shrink:0; text-align:center; } header.main-header h1 { color:var(--midnight-accent-primary); font-size: 1.4em; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.4); }
        .content-scroll { flex-grow:1; overflow-y:auto; scrollbar-width: thin; scrollbar-color: var(--midnight-accent-secondary) transparent; } .content-scroll::-webkit-scrollbar { width: 8px; } .content-scroll::-webkit-scrollbar-track { background: transparent; } .content-scroll::-webkit-scrollbar-thumb { background-color: var(--midnight-accent-secondary); border-radius: 4px; border: 2px solid var(--midnight-bg); }
        .dashboard-section, .collapsible-section { border-bottom: 1px solid var(--midnight-border); } .dashboard-section { padding: 20px; background-color: var(--midnight-surface); }
        .section-header h2, .dashboard-section > h3 { font-size: 0.8em; font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; display: flex; justify-content: space-between; align-items: center; color: var(--midnight-text-secondary); margin: 15px 0 8px 0; padding-bottom: 5px; border-bottom: 1px solid var(--midnight-border); } .section-header h2 { color: var(--midnight-accent-primary); margin: 0; padding: 0; border-bottom: none; flex-grow: 1; font-weight: 600; letter-spacing: 1px; }
        #weeklyCalendarContainer > h3 { text-align: center; color: var(--midnight-accent-alt); border-bottom: none; margin-bottom: 8px; font-weight: 600; letter-spacing: 1px;}
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .calendar-nav button { background: none; border: 1px solid var(--midnight-border); color: var(--midnight-text-secondary); padding: 4px 10px; border-radius: var(--border-radius-inner); font-size: 0.8em; cursor: pointer; transition: all var(--transition-speed-fast); } .calendar-nav button:hover { background-color: var(--midnight-accent-primary); color: #fff; border-color: var(--midnight-accent-primary); transform: translateY(-1px); } .calendar-nav button:active { transform: scale(0.97); } #calendarWeekLabel { font-size: 1em; font-weight: 600; color: var(--midnight-accent-alt); flex-grow: 1; text-align: center; }
        #upcomingListContainer > h3 { color: var(--midnight-text-secondary); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; } .day-header{font-size:0.7em;text-align:center;color:var(--midnight-text-secondary);padding-bottom:5px;font-weight:500;text-transform:uppercase;border-bottom:1px solid var(--midnight-border);margin-bottom:5px;} .day-cell{font-size:0.8em;text-align:center;background-color:var(--midnight-bg);border-radius:var(--border-radius-inner);padding:8px 4px;min-height:65px;display:flex;flex-direction:column;align-items:center;border:1px solid transparent; transition: background-color var(--transition-speed-fast), transform var(--transition-speed-fast);} .day-cell:hover { background-color: var(--midnight-surface-lighter); transform: scale(1.03);} .day-cell.today{border-color:var(--midnight-accent-alt);background-color:var(--midnight-surface-lighter); box-shadow: 0 0 8px rgba(240, 184, 121, 0.3);} .day-number{font-weight:600;margin-bottom:4px;color:var(--midnight-text-primary);} .day-cell.today .day-number{color:var(--midnight-accent-alt);} .day-assignments{list-style:none;padding:0;width:100%;} .assignment-marker{display:block;font-size:0.7em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background-color:var(--midnight-accent-secondary);color:var(--midnight-text-primary);padding:3px 5px;margin-top:4px;border-radius:4px;text-align:left; box-shadow: 0 1px 2px rgba(0,0,0,0.3);}
        #upcomingList{list-style:none;padding:0;} .upcoming-item{display:flex;justify-content:space-between;align-items:center;font-size:0.9em;padding:10px 5px;border-bottom:1px dashed var(--midnight-border); transition: background-color var(--transition-speed-fast);} .upcoming-item:last-child{border-bottom:none;} .upcoming-item:hover { background-color: rgba(255, 255, 255, 0.03); } .upcoming-item .date{color:var(--midnight-text-secondary);font-size:0.9em;white-space:nowrap;margin-left:10px;} .upcoming-item .type{font-weight:500;}
        .collapsible-section{background-color:var(--midnight-surface);} .section-header{padding:18px 20px;cursor:pointer;transition: background-color var(--transition-speed-fast), box-shadow var(--transition-speed-fast);position:relative;z-index:1; display: flex; align-items: center;} .section-header:hover{background-color:var(--midnight-surface-lighter); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); } .section-header i{font-size:0.9em;transition:transform var(--transition-speed-med) ease-out;color:var(--midnight-accent-primary);flex-shrink:0; margin-left: 10px;} .collapsible-section.is-open .section-header i{transform:rotate(90deg);} .section-content{max-height:0;overflow:hidden;transition: max-height var(--transition-speed-med) ease-out, padding var(--transition-speed-med) ease-out, border-top var(--transition-speed-med);padding:0 20px;background-color:var(--midnight-surface-lighter); border-top: 1px solid transparent;} .collapsible-section.is-open .section-content{max-height:2000px;padding:25px;transition:max-height var(--transition-speed-slow) ease-in-out, padding var(--transition-speed-slow) ease-in-out, border-top var(--transition-speed-slow); border-top: 1px solid var(--midnight-border); } #listSection.is-open .section-content{background-color:var(--midnight-bg);padding:0;}
        #assignmentForm{display:flex;flex-direction:column;gap:18px;} .form-group{display:flex;flex-direction:column;} .form-group#customTypeGroup{display:none;margin-top:-5px;padding-left:15px;border-left:3px solid var(--midnight-accent-primary);padding-top:10px; margin-left: 5px;} .form-group#customTypeGroup label{font-size:0.8em;} label{margin-bottom:6px;font-weight:500;font-size:0.85em;color:var(--midnight-text-secondary);letter-spacing: 0.5px;} select,input[type="date"],input[type="text"]{padding:14px 16px;background-color:var(--midnight-bg);border:1px solid var(--midnight-border);border-radius:var(--border-radius-inner);color:var(--midnight-text-primary);font-family:inherit;font-size:1rem;width:100%;transition: all var(--transition-speed-fast); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);} select:hover, input:hover { border-color: var(--midnight-text-secondary); } select:focus,input:focus{outline:none;border-color:var(--midnight-accent-primary);background-color: var(--midnight-surface); box-shadow:0 0 0 3px rgba(122,145,232,0.2), inset 0 1px 3px rgba(0,0,0,0.1);} select option,select optgroup{background-color:var(--midnight-bg);color:var(--midnight-text-primary);font-weight:normal;} select optgroup{padding:6px 0; font-weight: 600;} select optgroup[label="Mais Usados"]{font-style:normal;font-weight:bold;color:var(--midnight-accent-primary);} input[type="date"]{color: var(--midnight-text-secondary); } input[type="date"]:focus, input[type="date"]:valid { color: var(--midnight-text-primary); } input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(0.7);cursor:pointer;opacity:0.7;transition:opacity var(--transition-speed-fast);} input[type="date"]::-webkit-calendar-picker-indicator:hover{opacity:1;} button[type="submit"]{padding:15px 20px;background:linear-gradient(45deg, var(--midnight-accent-primary), var(--midnight-accent-secondary));color:#fff;border:none;border-radius:var(--border-radius-inner);cursor:pointer;font-size:1.05rem;font-weight:600;text-align:center;width:100%;margin-top:8px;transition: all var(--transition-speed-fast); box-shadow: 0 3px 8px rgba(0,0,0,0.3);} button[type="submit"]:hover{opacity:0.9; box-shadow: 0 5px 12px rgba(122, 145, 232, 0.3);} button[type="submit"]:active{transform:scale(0.97); box-shadow: 0 1px 3px rgba(0,0,0,0.2);}

        /* --- Lista Principal (REESTILIZADA) --- */
        .assignment-list { list-style: none; padding: 0; }
        .assignment-item {
            display: flex; flex-direction: column; /* MUDAN√áA */
            align-items: center; /* MUDAN√áA */
            text-align: center; /* MUDAN√áA */
            padding: 18px 15px; /* Ajuste Padding */
            color: var(--midnight-text-primary);
            border-bottom: 1px solid var(--midnight-border); cursor: pointer;
            transition: all var(--transition-speed-fast); position: relative;
        }
        .assignment-item:last-child { border-bottom: none; }
        .assignment-item:hover { transform: translateY(-2px); /* MUDAN√áA p/ indicar hover melhor */ filter: brightness(1.15); box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
        /* Cores ciclicas */
        .assignment-item:nth-child(5n+1){background-color:var(--list-color-1);} .assignment-item:nth-child(5n+2){background-color:var(--list-color-2);} .assignment-item:nth-child(5n+3){background-color:var(--list-color-3);} .assignment-item:nth-child(5n+4){background-color:var(--list-color-4);} .assignment-item:nth-child(5n){background-color:var(--list-color-5);}
        /* Estado Concluido */
        .assignment-item.is-completed { background-color: var(--completed-item-bg); opacity: 0.55; filter: grayscale(30%); }
        .assignment-item.is-completed:hover{ transform: translateY(0); filter: grayscale(30%) brightness(1); box-shadow: none;}
        /* Elementos Internos Reestilizados */
        .assignment-emoji { /* NOVO */
            font-size: 1.9em; /* Maior */
            margin-bottom: 8px; line-height: 1;
            display: block; /* Garante que √© um bloco */
            transition: transform var(--transition-speed-fast);
        }
         .assignment-item:hover .assignment-emoji { transform: scale(1.1); }
        .assignment-type { /* Era strong */
            font-size: 1em; font-weight: 600; margin-bottom: 6px;
            color: var(--midnight-text-primary); line-height: 1.3; display: block;
        }
        .assignment-date { /* Era span */
            font-size: 0.85em; font-weight: 500; color: var(--midnight-text-secondary); display: block;
        }
        .assignment-item.is-completed .assignment-emoji { filter: grayscale(80%); opacity: 0.7; transform: scale(1);}
        .assignment-item.is-completed .assignment-type { text-decoration: line-through; text-decoration-thickness: 1px; color: var(--midnight-text-secondary); }


        /* Modal (sem mudan√ßas) */
        .modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(10,10,15,0.8);backdrop-filter:blur(3px);justify-content:center;align-items:center;opacity:0;transition:opacity var(--transition-speed-med) ease-out;} .modal-overlay.is-visible{display:flex;opacity:1;} .modal-content{background-color:var(--midnight-surface);padding:30px;border-radius:var(--border-radius-inner);box-shadow:0 8px 25px rgba(0,0,0,0.5);width:90%;max-width:400px;position:relative;display:flex;flex-direction:column;gap:18px;border:1px solid var(--midnight-border);transform:scale(0.95);transition:transform var(--transition-speed-med) ease-out 0.1s;} .modal-overlay.is-visible .modal-content{transform:scale(1);} .modal-content h4{color:var(--midnight-accent-primary);margin-bottom:8px;text-align:center;font-size:1.2em;font-weight:600;word-break:break-word;} .modal-content .action-buttons,.modal-content .edit-view{display:flex;flex-direction:column;gap:12px;} .modal-content button{padding:12px 18px;border:none;border-radius:var(--border-radius-inner);cursor:pointer;font-weight:600;font-size:0.95em;transition:all var(--transition-speed-fast);width:100%;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 5px rgba(0,0,0,0.2);} .modal-content button:hover{opacity:0.9;box-shadow:0 4px 10px rgba(0,0,0,0.3);transform:translateY(-1px);} .modal-content button:active{transform:scale(0.97);box-shadow:0 1px 2px rgba(0,0,0,0.1);} #modalBtnComplete{background-color:var(--success-color);color:#111;} #modalBtnEdit{background-color:var(--midnight-accent-alt);color:#111;} #modalBtnDelete{background-color:var(--error-color);color:#fff;} #modalBtnCancel,#modalBtnCancelEdit{background-color:var(--midnight-surface-lighter);color:var(--midnight-text-primary);border:1px solid var(--midnight-border);} .edit-view{display:none;} .edit-view .form-group{width:100%;} .edit-view label{font-size:0.8em;} #modalBtnSaveEdit{background-color:var(--success-color);color:#111;}
        .no-assignments, .no-upcoming{font-size:0.9em;text-align:center;color:var(--midnight-text-secondary);padding:30px 20px;font-style:italic;background:transparent;} .no-assignments{padding:40px 20px;}
        #confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:2000;} .confetti-piece{position:absolute;width:10px;height:15px;opacity:0.9;animation:fallFadeOut 3.5s ease-in forwards;border-radius:3px;background-image:linear-gradient(45deg,var(--midnight-accent-primary),var(--success-color),var(--midnight-accent-alt));} @keyframes fallFadeOut{0%{transform:translateY(-30px) rotate(0deg) scale(1);opacity:1;}100%{transform:translateY(110vh) rotate(1080deg) scale(0.5);opacity:0;}}

    </style>
</head>
<body>
    <!-- HTML Continua igual -->
     <div class="mobile-view-container"><header class="main-header"><h1>Minhas Designa√ß√µes</h1></header><div class="content-scroll"><div class="dashboard-section"><div id="weeklyCalendarContainer"><div class="calendar-nav"><button id="prevWeekBtn">< Ant</button><span id="calendarWeekLabel"></span><button id="nextWeekBtn">Pr√≥x ></button></div><div id="weeklyCalendar" class="calendar-grid"></div></div><div id="upcomingListContainer"><h3>Pr√≥ximos 7 dias</h3><ul id="upcomingList"><li class="no-upcoming">...</li></ul></div></div><div class="collapsible-section" id="formSection"><div class="section-header" onclick="toggleSection('formSection')"><h2>Adicionar Nova</h2><i class="fas fa-chevron-right"></i></div><div class="section-content"><form id="assignmentForm"><div class="form-group"><label for="assignmentType">Tipo</label><select id="assignmentType" name="assignmentType" required><option value="" disabled selected>...</option></select></div><div class="form-group" id="customTypeGroup"><label for="customAssignmentType">Nome</label><input type="text" id="customAssignmentType" name="customAssignmentType" placeholder="..."></div><div class="form-group"><label for="assignmentDate">Data (1¬∫ dia p/ Assembleia)</label><input type="date" id="assignmentDate" name="assignmentDate" required></div><div class="form-group"><label for="assignmentNotes">Obs</label><input type="text" id="assignmentNotes" name="assignmentNotes" placeholder="..."></div><button type="submit">Adicionar</button></form></div></div><div class="collapsible-section is-open" id="listSection"><div class="section-header" onclick="toggleSection('listSection')"><h2>Todas Designa√ß√µes</h2><i class="fas fa-chevron-right"></i></div><div class="section-content"><ul id="assignmentsList" class="assignment-list"><li class="no-assignments">...</li></ul></div></div></div></div>
     <div id="actionModal" class="modal-overlay"><div class="modal-content"><h4 id="modalTitle">...</h4><input type="hidden" id="modalAssignmentId"><div class="action-buttons"><button id="modalBtnComplete"></button><button id="modalBtnEdit">Editar</button><button id="modalBtnDelete">Excluir</button><button id="modalBtnCancel">Cancelar</button></div><div class="edit-view"><div class="form-group"><label for="modalEditDate">Data</label><input type="date" id="modalEditDate"></div><div class="form-group"><label for="modalEditNotes">Obs</label><input type="text" id="modalEditNotes" placeholder="..."></div><button id="modalBtnSaveEdit">Salvar</button><button id="modalBtnCancelEdit">Cancelar</button></div></div></div>
     <div id="confetti-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Refer√™ncias DOM (Mantidas) ---
            const assignmentForm = document.getElementById('assignmentForm'); const assignmentTypeInput = document.getElementById('assignmentType'); const assignmentDateInput = document.getElementById('assignmentDate'); const assignmentNotesInput = document.getElementById('assignmentNotes'); const assignmentsListContainer = document.querySelector('#listSection .section-content ul'); const upcomingList = document.getElementById('upcomingList'); const customTypeGroup = document.getElementById('customTypeGroup'); const customAssignmentTypeInput = document.getElementById('customAssignmentType'); const weeklyCalendarGrid = document.getElementById('weeklyCalendar'); const actionModal = document.getElementById('actionModal'); const modalTitle = document.getElementById('modalTitle'); const modalAssignmentIdInput = document.getElementById('modalAssignmentId'); const modalActionButtonsDiv = actionModal.querySelector('.action-buttons'); const modalEditViewDiv = actionModal.querySelector('.edit-view'); const modalEditDateInput = document.getElementById('modalEditDate'); const modalEditNotesInput = document.getElementById('modalEditNotes'); const prevWeekBtn = document.getElementById('prevWeekBtn'); const nextWeekBtn = document.getElementById('nextWeekBtn'); const calendarWeekLabel = document.getElementById('calendarWeekLabel'); const confettiContainer = document.getElementById('confetti-container');

            // --- Constantes e Estado (Mantidas) ---
            const ASSIGNMENTS_STORAGE_KEY = 'jw_assignments_data_black_v1_final'; // Chave Final
            const UPCOMING_DAYS = 7; const TOP_N_FREQUENT = 5; const CONFETTI_COUNT = 50;
            const BASE_ASSIGNMENT_OPTIONS = { "Prepara√ß√£o e Organiza√ß√£o":["Presidente", "Dirigente de Campo", "Indicador (Entrada)", "Indicador (Audit√≥rio)", "Limpeza", "√Åudio", "V√≠deo"], "Reuni√£o de Congrega√ß√£o":["Condutor", "Leitura da B√≠blia", "Estudo B√≠blico da Congrega√ß√£o (Leitor)", "Estudo B√≠blico da Congrega√ß√£o (Dirigente)", "Discurso P√∫blico", "Discurso (Nossa vida Crist√£)", "Tesouros (Discurso 10 minutos)", "Joias Espirituais", "Fa√ßa seu melhor no minist√©rio", "Estudo de A Sentinela (Leitor)", "Estudo de A Sentinela (Dirigente)", "Ora√ß√£o Final"], "Eventos Especiais":["Assembleia", "Congresso", "Celebra√ß√£o", "Visita a Betel"], "Outros":["Personalizado"] };
            const ASSIGNMENT_EMOJIS = { "Presidente": "üßë‚Äç‚öñÔ∏è", "Dirigente de Campo": "üó∫Ô∏è", "Indicador (Entrada)": "üö™", "Indicador (Audit√≥rio)": "üèõÔ∏è", "Limpeza": "üßπ", "√Åudio": "üîä", "V√≠deo": "üìΩÔ∏è", "Condutor": "üé§", "Leitura da B√≠blia": "üìñ", "Estudo B√≠blico da Congrega√ß√£o (Leitor)": "ü§ì", "Estudo B√≠blico da Congrega√ß√£o (Dirigente)": "üßë‚Äçüè´", "Discurso P√∫blico": "üó£Ô∏è", "Discurso (Nossa vida Crist√£)": "üíñ", "Tesouros (Discurso 10 minutos)": "üíé", "Joias Espirituais": "‚ú®", "Fa√ßa seu melhor no minist√©rio": "üí™", "Estudo de A Sentinela (Leitor)": "üëÄ", "Estudo de A Sentinela (Dirigente)": "üßê", "Ora√ß√£o Final": "üôè", "Assembleia": "üèüÔ∏è", "Congresso": "üßë‚Äçü§ù‚Äçüßë", "Celebra√ß√£o": "üç∑", "Visita a Betel": "üè¢" };
            let appData = { assignments: [], frequency: {} }; let calendarWeekOffset = 0;

            // --- Armazenamento e Helpers (Mantidos) ---
            function loadAppData(){ const s=localStorage.getItem(ASSIGNMENTS_STORAGE_KEY); if(s){try{const p=JSON.parse(s); appData.assignments=Array.isArray(p.assignments)?p.assignments:[]; appData.frequency=typeof p.frequency==='object'&&p.frequency!==null?p.frequency:{};} catch(e){appData={assignments:[],frequency:{}};}} else{appData={assignments:[],frequency:{}};}}
            function saveAppData(){ try{localStorage.setItem(ASSIGNMENTS_STORAGE_KEY,JSON.stringify(appData));} catch(e){alert("Falha salvar!");}}
            function getEmojiForType(type){return ASSIGNMENT_EMOJIS[type]||'';}
            function formatDate(d,o={day:'2-digit',month:'2-digit',year:'numeric'}){if(!d)return '';try{const dt=new Date(`${d}T00:00:00`);return new Intl.DateTimeFormat('pt-BR',o).format(dt);}catch(e){const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d;}}
            function dateToYyyyMmDd(d){const dt=new Date(d);return`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;}
            function getTodayDateString(){return dateToYyyyMmDd(new Date());}
            function formatRelativeDate(ds){try{const t=new Date();t.setHours(0,0,0,0);const tg=new Date(`${ds}T00:00:00`);tg.setHours(0,0,0,0);if(isNaN(tg.getTime()))return ds;const diff=tg-t;const days=Math.ceil(diff/(1e3*60*60*24));const wk=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];const twk=wk[tg.getDay()];if(days<0)return formatDate(ds);if(days===0)return"Hoje";if(days===1)return"Amanh√£";if(days===2)return"Dep. Amanh√£";if(days<=6)return`Nesta ${twk}`;return formatDate(ds,{day:'2-digit',month:'short'});}catch(e){return formatDate(ds);}}
            function updateFrequency(t){if(t&&t!=='Personalizado'&&!t.startsWith('Assembleia (Dia')){appData.frequency[t]=(appData.frequency[t]||0)+1;}else if(t==='Assembleia'){appData.frequency['Assembleia']=(appData.frequency['Assembleia']||0)+1;}}
            function triggerConfetti(){const c=['var(--midnight-accent-primary)','var(--midnight-accent-alt)','var(--success-color)','var(--error-color)','var(--list-color-1)','var(--list-color-3)','var(--list-color-5)'];for(let i=0;i<CONFETTI_COUNT;i++){const p=document.createElement('div');p.classList.add('confetti-piece');p.style.background=c[Math.floor(Math.random()*c.length)];p.style.left=Math.random()*100+'vw';p.style.top=-10-Math.random()*30+'px';p.style.animationDuration=2.5+Math.random()*1.5+'s';p.style.animationDelay=Math.random()*0.5+'s';p.style.transform=`rotate(${Math.random()*360}deg) scale(${0.8+Math.random()*0.4})`;confettiContainer.appendChild(p);setTimeout(()=>{p.remove();},4500);}}

             // --- Fun√ß√µes de Renderiza√ß√£o ---
            function updateDropdownOrder() { const select=assignmentTypeInput;const currentSelection=select.value;select.innerHTML='<option value="" disabled selected>Selecione</option>';let allOptions=[];for(const g in BASE_ASSIGNMENT_OPTIONS){BASE_ASSIGNMENT_OPTIONS[g].forEach(o=>{if(o!=='Personalizado'){allOptions.push({value:o,text:o,group:g,freq:appData.frequency[o]||0});}});}allOptions.sort((a,b)=>(b.freq!==a.freq)?b.freq-a.freq:a.text.localeCompare(b.text));const topFreq=allOptions.slice(0,TOP_N_FREQUENT).filter(o=>o.freq>0).map(o=>o.value);const addedFreq=new Set();if(topFreq.length>0){const fg=document.createElement('optgroup');fg.label='Mais Usados';allOptions.forEach(o=>{if(topFreq.includes(o.value)){const op=document.createElement('option');op.value=o.value;op.textContent=`${getEmojiForType(o.value)} ${o.value==='Assembleia'?'Assembleia (3d)':o.text}`;fg.appendChild(op);addedFreq.add(o.value);}});if(fg.childElementCount>0)select.appendChild(fg);}for(const g in BASE_ASSIGNMENT_OPTIONS){const grp=document.createElement('optgroup');grp.label=g;let hasOpt=false;BASE_ASSIGNMENT_OPTIONS[g].forEach(o=>{if(!addedFreq.has(o)&&o!=='Personalizado'){const op=document.createElement('option');op.value=o;op.textContent=`${getEmojiForType(o)} ${o==='Assembleia'?'Assembleia (3d)':o}`;grp.appendChild(op);hasOpt=true;}});if(g==='Outros'){const custOpt=document.createElement('option');custOpt.value='Personalizado';custOpt.textContent='Personalizado';grp.appendChild(custOpt);hasOpt=true;}if(hasOpt){select.appendChild(grp);}}select.value=currentSelection||"";if(!select.value){select.querySelector('option[disabled]').selected=true;}select.dispatchEvent(new Event('change'));}
            function renderWeeklyCalendar(){weeklyCalendarGrid.innerHTML='';const today=new Date();const baseWeek=new Date(today);baseWeek.setDate(today.getDate()+(calendarWeekOffset*7));const dow=(baseWeek.getDay()+6)%7;const start=new Date(baseWeek);start.setDate(baseWeek.getDate()-dow);start.setHours(0,0,0,0);const end=new Date(start);end.setDate(start.getDate()+6);if(calendarWeekOffset===0){calendarWeekLabel.textContent="Esta Semana";}else if(calendarWeekOffset===1){calendarWeekLabel.textContent="Pr√≥xima Semana";}else if(calendarWeekOffset===-1){calendarWeekLabel.textContent="Semana Anterior";}else{calendarWeekLabel.textContent=`${formatDate(dateToYyyyMmDd(start),{day:'2-digit',month:'2-digit'})}-${formatDate(dateToYyyyMmDd(end),{day:'2-digit',month:'2-digit'})}`;}const hds=['Seg','Ter','Qua','Qui','Sex','S√°b','Dom'];hds.forEach(h=>{const d=document.createElement('div');d.className='day-header';d.textContent=h;weeklyCalendarGrid.appendChild(d);});for(let i=0;i<7;i++){const c=new Date(start);c.setDate(start.getDate()+i);const ds=dateToYyyyMmDd(c);const ce=document.createElement('div');ce.className='day-cell';if(calendarWeekOffset===0&&ds===dateToYyyyMmDd(new Date()))ce.classList.add('today');const n=document.createElement('span');n.className='day-number';n.textContent=c.getDate();ce.appendChild(n);const ul=document.createElement('ul');ul.className='day-assignments';ce.appendChild(ul);const ta=appData.assignments.filter(a=>a.date===ds&&!a.completed);ta.forEach(a=>{const li=document.createElement('li');li.className='assignment-marker';li.textContent=getEmojiForType(a.type)+' '+a.type;li.title=li.textContent;ul.appendChild(li);});weeklyCalendarGrid.appendChild(ce);}}
            function renderUpcomingList(){upcomingList.innerHTML='';const today=new Date();today.setHours(0,0,0,0);const cutoff=new Date(today);cutoff.setDate(today.getDate()+UPCOMING_DAYS);const upcoming=appData.assignments.filter(a=>{try{const d=new Date(a.date+'T00:00:00');d.setHours(0,0,0,0);return !isNaN(d)&&d>=today&&d<cutoff&&!a.completed;}catch(e){return false;}}).sort((a,b)=>new Date(a.date+'T00:00:00')-new Date(b.date+'T00:00:00'));if(upcoming.length===0){upcomingList.innerHTML='<li class="no-upcoming">Nada p/ '+UPCOMING_DAYS+' dias</li>';}else{upcoming.forEach(a=>{const li=document.createElement('li');li.className='upcoming-item';const t=document.createElement('span');t.className='type';t.textContent=getEmojiForType(a.type)+' '+a.type;const dt=document.createElement('span');dt.className='date';dt.textContent=formatRelativeDate(a.date);li.appendChild(t);li.appendChild(dt);upcomingList.appendChild(li);});}}

             // MODIFICADO: Cria elementos separados para o card centrado
            function renderAssignments() {
                const container = assignmentsListContainer; container.innerHTML = '';
                if (appData.assignments.length === 0) { container.innerHTML = '<li class="no-assignments">Nada cadastrado</li>'; return; }
                const sorted = [...appData.assignments].sort((a,b)=>{ if (a.completed!==b.completed) { return a.completed ? 1 : -1; } try { return new Date(a.date+'T00:00:00') - new Date(b.date+'T00:00:00'); } catch (e) { return 0; } });

                 sorted.forEach(a => {
                    const li = document.createElement('li');
                    li.className = 'assignment-item'; li.dataset.id = a.id;
                    if (a.completed) li.classList.add('is-completed');

                     // 1. Emoji Span
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'assignment-emoji';
                    emojiSpan.textContent = getEmojiForType(a.type); // S√≥ Emoji
                    li.appendChild(emojiSpan);

                    // 2. Tipo Span/Strong
                    const typeSpan = document.createElement('span'); // Usando span por sem√¢ntica, estilizado via classe
                    typeSpan.className = 'assignment-type';
                    typeSpan.textContent = a.type; // S√≥ o Tipo
                    li.appendChild(typeSpan);

                     // 3. Data Span
                     const dateSpan = document.createElement('span');
                     dateSpan.className = 'assignment-date';
                     dateSpan.textContent = formatRelativeDate(a.date);
                     li.appendChild(dateSpan);

                    // N√£o inclui as notas aqui para manter layout de 3 linhas

                    container.appendChild(li);
                });
            }

             // --- L√≥gica do Formul√°rio Principal (Mantida) ---
             function addAssignment(event){event.preventDefault();let tS=assignmentTypeInput.value;const bDS=assignmentDateInput.value;const n=assignmentNotesInput.value.trim();let fT=tS;let tFF=tS;const todayS=getTodayDateString();if(bDS&&bDS<todayS){alert('Data passada?');assignmentDateInput.focus();return;}if(tS!=='Personalizado'&&tS!=='Assembleia'){const exists=appData.assignments.some(a=>a.type===tS&&a.date===bDS);if(exists){alert(`"${getEmojiForType(tS)} ${tS}" j√° existe p/ ${formatDate(bDS)}.`);return;}}else if(tS==='Personalizado'){fT=customAssignmentTypeInput.value.trim();tFF=fT;if(!fT){alert('Nome?');customAssignmentTypeInput.focus();return;}const cE=appData.assignments.some(a=>a.type===fT&&a.date===bDS);if(cE){alert(`"${fT}" j√° existe p/ ${formatDate(bDS)}.`);return;}}else if(tS==='Assembleia'){const a1E=appData.assignments.some(a=>a.type==='Assembleia (Dia 1)'&&a.date===bDS);if(a1E){alert(`Assembleia j√° cadastrada em ${formatDate(bDS)}.`);return;}}if(tS==='Assembleia'){if(!bDS){alert('Data 1¬∫ dia?');assignmentDateInput.focus();return;}const sd=new Date(`${bDS}T00:00:00`);if(isNaN(sd.getTime())){alert('Data inv√°lida.');return;}let added=0;for(let i=0;i<3;i++){const cd=new Date(sd);cd.setDate(sd.getDate()+i);const cds=dateToYyyyMmDd(cd);const ass={id:Date.now()+Math.random()+i,type:`Assembleia (Dia ${i+1})`,date:cds,notes:n,completed:false};appData.assignments.push(ass);added++;}if(added===3){updateFrequency('Assembleia');saveAppData();renderAssignments();renderUpcomingList();renderWeeklyCalendar();updateDropdownOrder();assignmentForm.reset();customTypeGroup.style.display='none';customAssignmentTypeInput.value='';customAssignmentTypeInput.required=false;assignmentTypeInput.value="";toggleSection('formSection');}else{alert("Erro dias.");}return;}if(!fT||fT==='Personalizado'||!bDS){alert('Verifique Tipo/Data.');if(!bDS)assignmentDateInput.focus();else if(!fT&&tS!=='Personalizado')assignmentTypeInput.focus();return;}if(!/^\d{4}-\d{2}-\d{2}$/.test(bDS)){alert('Data?');return;}const nA={id:Date.now()+Math.random(),type:fT,date:bDS,notes:n,completed:false};appData.assignments.push(nA);updateFrequency(tFF);saveAppData();renderAssignments();renderUpcomingList();renderWeeklyCalendar();updateDropdownOrder();assignmentForm.reset();customTypeGroup.style.display='none';customAssignmentTypeInput.value='';customAssignmentTypeInput.required=false;assignmentTypeInput.value="";toggleSection('formSection');}

             // --- L√≥gica do Modal (Exclus√£o sem Confirma√ß√£o JS) ---
            function showActionModal(id){const a=appData.assignments.find(x=>x.id==id);if(!a)return;modalAssignmentIdInput.value=id;modalTitle.textContent=`A√ß√µes: ${getEmojiForType(a.type)} ${a.type}`;modalActionButtonsDiv.style.display='flex';modalEditViewDiv.style.display='none';const cb=document.getElementById('modalBtnComplete');cb.textContent=a.completed?'Desmarcar Conclus√£o':'Marcar Conclu√≠da';actionModal.classList.add('is-visible');}
            function hideActionModal(){actionModal.classList.remove('is-visible');modalAssignmentIdInput.value='';modalEditDateInput.value='';modalEditNotesInput.value='';}
            function handleCompleteToggle(){const id=modalAssignmentIdInput.value;const idx=appData.assignments.findIndex(a=>a.id==id);if(idx===-1)return;const willBeCompleted=!appData.assignments[idx].completed;appData.assignments[idx].completed=willBeCompleted;saveAppData();renderAssignments();renderUpcomingList();renderWeeklyCalendar();if(willBeCompleted){triggerConfetti();}hideActionModal();}
            function handleEditRequest(){const id=modalAssignmentIdInput.value;const a=appData.assignments.find(x=>x.id==id);if(!a)return;modalEditDateInput.value=a.date;modalEditNotesInput.value=a.notes||'';modalActionButtonsDiv.style.display='none';modalEditViewDiv.style.display='flex';}
            function handleSaveEdit(){const id=modalAssignmentIdInput.value;const idx=appData.assignments.findIndex(a=>a.id==id);if(idx===-1)return;const nd=modalEditDateInput.value;const nn=modalEditNotesInput.value.trim();const todayS=getTodayDateString();if(!nd||!/^\d{4}-\d{2}-\d{2}$/.test(nd)){alert("Data inv√°lida.");modalEditDateInput.focus();return;}if(nd<todayS){alert("Data passada?");modalEditDateInput.focus();return;}appData.assignments[idx].date=nd;appData.assignments[idx].notes=nn;saveAppData();renderAssignments();renderUpcomingList();renderWeeklyCalendar();hideActionModal();}

             // MODIFICADO: Remove confirma√ß√£o JS
             function deleteAssignment(id){ const a = appData.assignments.find(x=>x.id == id); if (!a) return; /* Removido IF CONFIRM */ appData.assignments=appData.assignments.filter(x=>x.id != id); saveAppData(); renderAssignments(); renderUpcomingList(); renderWeeklyCalendar();}
             function handleDeleteRequest(){ const id = modalAssignmentIdInput.value; deleteAssignment(id); hideActionModal();}


            // --- Event Listeners (Mantidos) ---
            assignmentsListContainer.addEventListener('click',(e)=>{const i=e.target.closest('.assignment-item');if(i&&i.dataset.id){showActionModal(i.dataset.id);}});actionModal.addEventListener('click',(e)=>{if(e.target===actionModal){hideActionModal();}});document.getElementById('modalBtnComplete').addEventListener('click',handleCompleteToggle);document.getElementById('modalBtnEdit').addEventListener('click',handleEditRequest);document.getElementById('modalBtnDelete').addEventListener('click',handleDeleteRequest);document.getElementById('modalBtnCancel').addEventListener('click',hideActionModal);document.getElementById('modalBtnSaveEdit').addEventListener('click',handleSaveEdit);document.getElementById('modalBtnCancelEdit').addEventListener('click',hideActionModal);window.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&actionModal.classList.contains('is-visible')){hideActionModal();}});window.toggleSection=(id)=>{const el=document.getElementById(id);if(el)el.classList.toggle('is-open');};assignmentTypeInput.addEventListener('change',()=>{if(assignmentTypeInput.value==='Personalizado'){customTypeGroup.style.display='flex';customAssignmentTypeInput.required=true;setTimeout(()=>customAssignmentTypeInput.focus(),50);}else{customTypeGroup.style.display='none';customAssignmentTypeInput.required=false;customAssignmentTypeInput.value='';}});assignmentForm.addEventListener('submit',addAssignment);prevWeekBtn.addEventListener('click',()=>{calendarWeekOffset--;renderWeeklyCalendar();});nextWeekBtn.addEventListener('click',()=>{calendarWeekOffset++;renderWeeklyCalendar();});

            // --- Inicializa√ß√£o (Mantida) ---
             function initializeApp() { loadAppData(); updateDropdownOrder(); renderAssignments(); renderUpcomingList(); renderWeeklyCalendar(); assignmentTypeInput.dispatchEvent(new Event('change')); }
             initializeApp();

        });
    </script>
</body>
</html>
